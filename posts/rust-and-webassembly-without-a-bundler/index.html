<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="description" content="Programming, game development and other technical tidbits">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Rust and WebAssembly without a Bundler | Tung&#x27;s Word Box</title>
  <link rel="icon" href="https://tung.github.io/favicon.png" type="image/png" sizes="any">
  <link rel="stylesheet" href="https://tung.github.io/tufte.css">
  <link rel="stylesheet" href="https://tung.github.io/site.css">
  
    <link rel="alternate" type="application/atom+xml" title="Tung&#x27;s Word Box" href="https://tung.github.io/atom.xml">
  
</head>

<body>
  <header>
    <div class="home">
      <a href="https://tung.github.io">Tung&#x27;s Word Box</a>
    </div>
    <nav>
      <a href="https://tung.github.io/posts/">Posts</a>
      <a href="https://tung.github.io/tags/">Tags</a>
      <a href="https://tung.github.io/projects/">Projects</a>
      <a href="https://github.com/tung">GitHub</a>
      <a href="https://tungtn.itch.io">itch.io</a>
    </nav>
    <div style="clear: both"></div>
  </header>

  
  <h1>Rust and WebAssembly without a Bundler</h1>
  <article>
    
    
    <p class="meta">
        Posted on 2022-08-04, 
        Updated 2022-08-06; 
        Tags:
        <span class="tags">
              <a href="https://tung.github.io/tags/javascript/">javascript</a>,
              <a href="https://tung.github.io/tags/programming/">programming</a>,
              <a href="https://tung.github.io/tags/rust/">rust</a>,
              <a href="https://tung.github.io/tags/webassembly/">webassembly</a>,
              <a href="https://tung.github.io/tags/webdev/">webdev</a>
        </span>
    </p>
    <br>
    <p>If you're just getting into compiling your Rust code into WebAssembly and want to load it in a web browser, you might be taken aback by the multitude of ways of doing so.
This seems to be due to the differing pace of web browsers implementing web platform features over the years.
A lot of entry-level guides to using Rust and WebAssembly make use of a JavaScript bundler for convenience, but this obscures the relationship between Rust, WebAssembly, JavaScript and HTML, so instead we're going to try doing this all by hand.
Specifically, we're going to compile some Rust code into WebAssembly and do a run-down of the ways to load it directly in a web page using just JavaScript.
If you want to follow along at home, make sure you have Rust installed and the <code>wasm32-unknown-unknown</code> target:</p>
<pre class="z-code"><code><span class="z-text z-plain">rustup target add wasm32-unknown-unknown
</span></code></pre>
<p>We're going to look at these loading methods through the perspective of compatibility with three desktop web browsers: Chrome, Firefox and Safari.
I'll be consulting the extremely-helpful <a href="https://caniuse.com">Can I use</a> website for this info.</p>
<p>Ready?
Okay, let's go!</p>
<span id="continue-reading"></span><h2 id="webassembly"><a class="zola-anchor" href="#webassembly" aria-label="Anchor link for: webassembly">&num;</a>
WebAssembly</h2>
<p><a href="https://caniuse.com/wasm">https://caniuse.com/wasm</a></p>
<ul>
<li>Chrome 57: March 9, 2017</li>
<li>Firefox 52: March 7, 2017</li>
<li>Safari 11: September 19, 2017</li>
</ul>
<p>There's no point trying to load WebAssembly in a browser if it doesn't support it.
However, if it does, we can generally assume the presence of other things like <a href="https://caniuse.com/arrow-functions">arrow functions</a>, which is covenient.</p>
<h2 id="webassembly-instantiate"><a class="zola-anchor" href="#webassembly-instantiate" aria-label="Anchor link for: webassembly-instantiate">&num;</a>
<code>WebAssembly.instantiate</code></h2>
<p>This method uses <a href="https://caniuse.com/mdn-javascript_builtins_webassembly_instantiate"><code>WebAssembly.instantiate</code></a>, which is supported by all versions of Chrome, Firefox and Safari that also support WebAssembly.</p>
<p>We'll create a new Rust project that gets JavaScript to call a Rust <code>main</code> function that in turn calls a JavaScript-defined <code>log_number</code> function, then have JavaScript call another Rust function named <code>add</code>:</p>
<pre class="z-code"><code><span class="z-text z-plain">cargo new wasm-instantiate
</span></code></pre>
<p>Add files with the following contents:</p>
<details open><summary><code>wasm-instantiate/src/main.rs</code>:</summary>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-keyword z-other z-rust">extern</span> <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>C<span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">log_number</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-variable z-parameter z-rust">number</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-type z-rust">u32</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">main</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-modifier z-rust">unsafe</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        <span class="z-support z-function z-rust">log_number</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-numeric z-integer z-decimal z-rust">42</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">no_mangle</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
</span><span class="z-source z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-keyword z-other z-rust">extern</span> <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>C<span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span> <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">add</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-variable z-parameter z-rust">a</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-type z-rust">u32</span>, <span class="z-variable z-parameter z-rust">b</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-type z-rust">u32</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-&gt;</span> <span class="z-storage z-type z-rust">u32</span></span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    a <span class="z-keyword z-operator z-arithmetic z-rust">+</span> b
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
</details>
<details open><summary><code>wasm-instantiate/index.html</code>:</summary>
<pre data-lang="html" class="language-html z-code"><code class="language-html" data-lang="html"><span class="z-text z-html z-basic"><span class="z-meta z-tag z-sgml z-doctype z-html"><span class="z-punctuation z-definition z-tag z-begin z-html">&lt;!</span><span class="z-keyword z-declaration z-doctype z-html">DOCTYPE</span> <span class="z-constant z-language z-doctype z-html">html</span><span class="z-punctuation z-definition z-tag z-end z-html">&gt;</span></span>
</span><span class="z-text z-html z-basic"><span class="z-meta z-tag z-structure z-any z-html"><span class="z-punctuation z-definition z-tag z-begin z-html">&lt;</span><span class="z-entity z-name z-tag z-structure z-any z-html">html</span> <span class="z-meta z-attribute-with-value z-html"><span class="z-entity z-other z-attribute-name z-html">lang</span><span class="z-punctuation z-separator z-key-value z-html">=</span><span class="z-string z-quoted z-double z-html"><span class="z-punctuation z-definition z-string z-begin z-html">&quot;</span>en<span class="z-punctuation z-definition z-string z-end z-html">&quot;</span></span></span><span class="z-punctuation z-definition z-tag z-end z-html">&gt;</span></span>
</span><span class="z-text z-html z-basic">  <span class="z-meta z-tag z-structure z-any z-html"><span class="z-punctuation z-definition z-tag z-begin z-html">&lt;</span><span class="z-entity z-name z-tag z-structure z-any z-html">head</span><span class="z-punctuation z-definition z-tag z-end z-html">&gt;</span></span>
</span><span class="z-text z-html z-basic">    <span class="z-meta z-tag z-inline z-any z-html"><span class="z-punctuation z-definition z-tag z-begin z-html">&lt;</span><span class="z-entity z-name z-tag z-inline z-any z-html">meta</span> <span class="z-meta z-attribute-with-value z-html"><span class="z-entity z-other z-attribute-name z-html">charset</span><span class="z-punctuation z-separator z-key-value z-html">=</span><span class="z-string z-quoted z-double z-html"><span class="z-punctuation z-definition z-string z-begin z-html">&quot;</span>utf-8<span class="z-punctuation z-definition z-string z-end z-html">&quot;</span></span></span><span class="z-punctuation z-definition z-tag z-end z-html">&gt;</span></span>
</span><span class="z-text z-html z-basic">    <span class="z-meta z-tag z-inline z-any z-html"><span class="z-punctuation z-definition z-tag z-begin z-html">&lt;</span><span class="z-entity z-name z-tag z-inline z-any z-html">title</span><span class="z-punctuation z-definition z-tag z-end z-html">&gt;</span></span>Rust WASM Demo<span class="z-meta z-tag z-inline z-any z-html"><span class="z-punctuation z-definition z-tag z-begin z-html">&lt;/</span><span class="z-entity z-name z-tag z-inline z-any z-html">title</span><span class="z-punctuation z-definition z-tag z-end z-html">&gt;</span></span>
</span><span class="z-text z-html z-basic">  <span class="z-meta z-tag z-structure z-any z-html"><span class="z-punctuation z-definition z-tag z-begin z-html">&lt;/</span><span class="z-entity z-name z-tag z-structure z-any z-html">head</span><span class="z-punctuation z-definition z-tag z-end z-html">&gt;</span></span>
</span><span class="z-text z-html z-basic">  <span class="z-meta z-tag z-structure z-any z-html"><span class="z-punctuation z-definition z-tag z-begin z-html">&lt;</span><span class="z-entity z-name z-tag z-structure z-any z-html">body</span><span class="z-punctuation z-definition z-tag z-end z-html">&gt;</span></span>
</span><span class="z-text z-html z-basic">    <span class="z-meta z-tag z-script z-begin z-html"><span class="z-punctuation z-definition z-tag z-begin z-html">&lt;</span><span class="z-entity z-name z-tag z-script z-html">script</span></span><span class="z-meta z-tag z-script z-begin z-html"><span class="z-punctuation z-definition z-tag z-end z-html">&gt;</span></span>
</span><span class="z-text z-html z-basic">      <span class="z-source z-js z-embedded z-html"><span class="z-source z-js"><span class="z-storage z-type z-js">let</span> <span class="z-meta z-binding z-name z-js"><span class="z-variable z-other z-readwrite z-js">imports</span></span> <span class="z-keyword z-operator z-assignment z-js">=</span> <span class="z-meta z-mapping z-js"><span class="z-punctuation z-section z-block z-begin z-js">{</span>
</span></span></span></span><span class="z-text z-html z-basic"><span class="z-source z-js z-embedded z-html"><span class="z-source z-js"><span class="z-meta z-mapping z-js">        <span class="z-meta z-mapping z-key z-js">env</span><span class="z-punctuation z-separator z-key-value z-js">:</span> <span class="z-meta z-mapping z-js"><span class="z-punctuation z-section z-block z-begin z-js">{</span>
</span></span></span></span></span><span class="z-text z-html z-basic"><span class="z-source z-js z-embedded z-html"><span class="z-source z-js"><span class="z-meta z-mapping z-js"><span class="z-meta z-mapping z-js">          <span class="z-meta z-function z-declaration z-js"><span class="z-meta z-mapping z-key z-js"><span class="z-entity z-name z-function z-js">log_number</span></span><span class="z-punctuation z-separator z-key-value z-js">:</span> </span><span class="z-meta z-function z-js"></span><span class="z-meta z-function z-declaration z-js"><span class="z-punctuation z-section z-group z-begin z-js">(</span><span class="z-meta z-binding z-name z-js"><span class="z-variable z-parameter z-function z-js">number</span></span><span class="z-punctuation z-section z-group z-end z-js">)</span> <span class="z-storage z-type z-function z-arrow z-js">=&gt;</span></span><span class="z-meta z-function z-js"> <span class="z-meta z-block z-js"><span class="z-meta z-function-call z-method z-js"><span class="z-support z-type z-object z-console z-js">console</span><span class="z-punctuation z-accessor z-js">.</span><span class="z-support z-function z-console z-js">log</span><span class="z-meta z-group z-js"><span class="z-punctuation z-section z-group z-begin z-js">(</span><span class="z-meta z-string z-js"><span class="z-string z-quoted z-other z-js"><span class="z-punctuation z-definition z-string z-begin z-js">`</span>Number from Rust: </span><span class="z-meta z-interpolation z-js"><span class="z-punctuation z-section z-interpolation z-begin z-js">${</span></span><span class="z-meta z-interpolation z-js"><span class="z-source z-js z-embedded"><span class="z-variable z-other z-readwrite z-js">number</span></span><span class="z-punctuation z-section z-interpolation z-end z-js">}</span></span><span class="z-string z-quoted z-other z-js"><span class="z-punctuation z-definition z-string z-end z-js">`</span></span></span><span class="z-punctuation z-section z-group z-end z-js">)</span></span>
</span></span></span></span></span></span></span></span><span class="z-text z-html z-basic"><span class="z-source z-js z-embedded z-html"><span class="z-source z-js"><span class="z-meta z-mapping z-js"><span class="z-meta z-mapping z-js"><span class="z-meta z-function z-js"><span class="z-meta z-block z-js"><span class="z-meta z-function-call z-method z-js">        </span></span></span><span class="z-punctuation z-section z-block z-end z-js">}</span></span>
</span></span></span></span><span class="z-text z-html z-basic"><span class="z-source z-js z-embedded z-html"><span class="z-source z-js"><span class="z-meta z-mapping z-js">      <span class="z-punctuation z-section z-block z-end z-js">}</span></span><span class="z-punctuation z-terminator z-statement z-js">;</span>
</span></span></span><span class="z-text z-html z-basic"><span class="z-source z-js z-embedded z-html"><span class="z-source z-js">      <span class="z-meta z-function-call z-js"><span class="z-variable z-function z-js">fetch</span><span class="z-meta z-group z-js"><span class="z-punctuation z-section z-group z-begin z-js">(</span><span class="z-meta z-string z-js"><span class="z-string z-quoted z-single z-js"><span class="z-punctuation z-definition z-string z-begin z-js">&#39;</span>target/wasm32-unknown-unknown/release/wasm-instantiate.wasm<span class="z-punctuation z-definition z-string z-end z-js">&#39;</span></span></span><span class="z-punctuation z-section z-group z-end z-js">)</span></span>
</span></span></span></span><span class="z-text z-html z-basic"><span class="z-source z-js z-embedded z-html"><span class="z-source z-js"><span class="z-meta z-function-call z-js">        </span><span class="z-punctuation z-accessor z-js">.</span><span class="z-meta z-function-call z-method z-js"><span class="z-variable z-function z-js">then</span><span class="z-meta z-group z-js"><span class="z-punctuation z-section z-group z-begin z-js">(</span><span class="z-meta z-function z-js"></span><span class="z-meta z-function z-declaration z-js"><span class="z-punctuation z-section z-group z-begin z-js">(</span><span class="z-meta z-binding z-name z-js"><span class="z-variable z-parameter z-function z-js">response</span></span><span class="z-punctuation z-section z-group z-end z-js">)</span> <span class="z-storage z-type z-function z-arrow z-js">=&gt;</span></span><span class="z-meta z-function z-js"> <span class="z-meta z-block z-js"><span class="z-meta z-function-call z-method z-js"><span class="z-variable z-other z-readwrite z-js">response</span><span class="z-punctuation z-accessor z-js">.</span><span class="z-variable z-function z-js">arrayBuffer</span><span class="z-meta z-group z-js"><span class="z-punctuation z-section z-group z-begin z-js">(</span><span class="z-punctuation z-section z-group z-end z-js">)</span></span></span></span></span><span class="z-punctuation z-section z-group z-end z-js">)</span></span>
</span></span></span></span><span class="z-text z-html z-basic"><span class="z-source z-js z-embedded z-html"><span class="z-source z-js"><span class="z-meta z-function-call z-method z-js">        </span><span class="z-punctuation z-accessor z-js">.</span><span class="z-meta z-function-call z-method z-js"><span class="z-variable z-function z-js">then</span><span class="z-meta z-group z-js"><span class="z-punctuation z-section z-group z-begin z-js">(</span><span class="z-meta z-function z-js"></span><span class="z-meta z-function z-declaration z-js"><span class="z-punctuation z-section z-group z-begin z-js">(</span><span class="z-meta z-binding z-name z-js"><span class="z-variable z-parameter z-function z-js">bytes</span></span><span class="z-punctuation z-section z-group z-end z-js">)</span> <span class="z-storage z-type z-function z-arrow z-js">=&gt;</span></span><span class="z-meta z-function z-js"> <span class="z-meta z-block z-js"><span class="z-meta z-function-call z-method z-js"><span class="z-support z-class z-js">WebAssembly</span><span class="z-punctuation z-accessor z-js">.</span><span class="z-variable z-function z-js">instantiate</span><span class="z-meta z-group z-js"><span class="z-punctuation z-section z-group z-begin z-js">(</span><span class="z-variable z-other z-readwrite z-js">bytes</span><span class="z-punctuation z-separator z-comma z-js">,</span> <span class="z-variable z-other z-readwrite z-js">imports</span><span class="z-punctuation z-section z-group z-end z-js">)</span></span></span></span></span><span class="z-punctuation z-section z-group z-end z-js">)</span></span>
</span></span></span></span><span class="z-text z-html z-basic"><span class="z-source z-js z-embedded z-html"><span class="z-source z-js"><span class="z-meta z-function-call z-method z-js">        </span><span class="z-punctuation z-accessor z-js">.</span><span class="z-meta z-function-call z-method z-js"><span class="z-variable z-function z-js">then</span><span class="z-meta z-group z-js"><span class="z-punctuation z-section z-group z-begin z-js">(</span><span class="z-meta z-function z-js"></span><span class="z-meta z-function z-declaration z-js"><span class="z-punctuation z-section z-group z-begin z-js">(</span><span class="z-meta z-binding z-name z-js"><span class="z-variable z-parameter z-function z-js">result</span></span><span class="z-punctuation z-section z-group z-end z-js">)</span> <span class="z-storage z-type z-function z-arrow z-js">=&gt;</span></span><span class="z-meta z-function z-js"> <span class="z-meta z-block z-js"><span class="z-punctuation z-section z-block z-begin z-js">{</span>
</span></span></span></span></span></span></span><span class="z-text z-html z-basic"><span class="z-source z-js z-embedded z-html"><span class="z-source z-js"><span class="z-meta z-function-call z-method z-js"><span class="z-meta z-group z-js"><span class="z-meta z-function z-js"><span class="z-meta z-block z-js">          <span class="z-meta z-function-call z-method z-js"><span class="z-variable z-other z-readwrite z-js">result</span><span class="z-punctuation z-accessor z-js">.</span><span class="z-meta z-property z-object z-js">instance</span><span class="z-punctuation z-accessor z-js">.</span><span class="z-meta z-property z-object z-js">exports</span><span class="z-punctuation z-accessor z-js">.</span><span class="z-variable z-function z-js">main</span><span class="z-meta z-group z-js"><span class="z-punctuation z-section z-group z-begin z-js">(</span><span class="z-punctuation z-section z-group z-end z-js">)</span></span></span><span class="z-punctuation z-terminator z-statement z-js">;</span>
</span></span></span></span></span></span></span><span class="z-text z-html z-basic"><span class="z-source z-js z-embedded z-html"><span class="z-source z-js"><span class="z-meta z-function-call z-method z-js"><span class="z-meta z-group z-js"><span class="z-meta z-function z-js"><span class="z-meta z-block z-js">          <span class="z-storage z-type z-js">const</span> <span class="z-meta z-binding z-name z-js"><span class="z-variable z-other z-readwrite z-js">sum</span></span> <span class="z-keyword z-operator z-assignment z-js">=</span> <span class="z-meta z-function-call z-method z-js"><span class="z-variable z-other z-readwrite z-js">result</span><span class="z-punctuation z-accessor z-js">.</span><span class="z-meta z-property z-object z-js">instance</span><span class="z-punctuation z-accessor z-js">.</span><span class="z-meta z-property z-object z-js">exports</span><span class="z-punctuation z-accessor z-js">.</span><span class="z-variable z-function z-js">add</span><span class="z-meta z-group z-js"><span class="z-punctuation z-section z-group z-begin z-js">(</span><span class="z-constant z-numeric z-integer z-decimal z-js">1</span><span class="z-punctuation z-separator z-comma z-js">,</span> <span class="z-constant z-numeric z-integer z-decimal z-js">2</span><span class="z-punctuation z-section z-group z-end z-js">)</span></span></span><span class="z-punctuation z-terminator z-statement z-js">;</span>
</span></span></span></span></span></span></span><span class="z-text z-html z-basic"><span class="z-source z-js z-embedded z-html"><span class="z-source z-js"><span class="z-meta z-function-call z-method z-js"><span class="z-meta z-group z-js"><span class="z-meta z-function z-js"><span class="z-meta z-block z-js">          <span class="z-meta z-function-call z-method z-js"><span class="z-support z-type z-object z-console z-js">console</span><span class="z-punctuation z-accessor z-js">.</span><span class="z-support z-function z-console z-js">log</span><span class="z-meta z-group z-js"><span class="z-punctuation z-section z-group z-begin z-js">(</span><span class="z-meta z-string z-js"><span class="z-string z-quoted z-other z-js"><span class="z-punctuation z-definition z-string z-begin z-js">`</span>1 + 2 = </span><span class="z-meta z-interpolation z-js"><span class="z-punctuation z-section z-interpolation z-begin z-js">${</span></span><span class="z-meta z-interpolation z-js"><span class="z-source z-js z-embedded"><span class="z-variable z-other z-readwrite z-js">sum</span></span><span class="z-punctuation z-section z-interpolation z-end z-js">}</span></span><span class="z-string z-quoted z-other z-js"><span class="z-punctuation z-definition z-string z-end z-js">`</span></span></span><span class="z-punctuation z-section z-group z-end z-js">)</span></span></span><span class="z-punctuation z-terminator z-statement z-js">;</span>
</span></span></span></span></span></span></span><span class="z-text z-html z-basic"><span class="z-source z-js z-embedded z-html"><span class="z-source z-js"><span class="z-meta z-function-call z-method z-js"><span class="z-meta z-group z-js"><span class="z-meta z-function z-js"><span class="z-meta z-block z-js">        <span class="z-punctuation z-section z-block z-end z-js">}</span></span></span><span class="z-punctuation z-section z-group z-end z-js">)</span></span></span><span class="z-punctuation z-terminator z-statement z-js">;</span>
</span></span></span><span class="z-text z-html z-basic"><span class="z-source z-js z-embedded z-html"><span class="z-source z-js">    </span></span><span class="z-meta z-tag z-script z-end z-html"><span class="z-punctuation z-definition z-tag z-begin z-html">&lt;/</span><span class="z-entity z-name z-tag z-script z-html">script</span><span class="z-punctuation z-definition z-tag z-end z-html">&gt;</span></span>
</span><span class="z-text z-html z-basic">  <span class="z-meta z-tag z-structure z-any z-html"><span class="z-punctuation z-definition z-tag z-begin z-html">&lt;/</span><span class="z-entity z-name z-tag z-structure z-any z-html">body</span><span class="z-punctuation z-definition z-tag z-end z-html">&gt;</span></span>
</span><span class="z-text z-html z-basic"><span class="z-meta z-tag z-structure z-any z-html"><span class="z-punctuation z-definition z-tag z-begin z-html">&lt;/</span><span class="z-entity z-name z-tag z-structure z-any z-html">html</span><span class="z-punctuation z-definition z-tag z-end z-html">&gt;</span></span>
</span></code></pre>
</details>
<p>Build the WebAssembly blob from the Rust code:</p>
<pre class="z-code"><code><span class="z-text z-plain">cargo build --release --target=wasm32-unknown-unknown
</span></code></pre>
<p>Fire up a local web server (in Ubuntu Linux using <code>python3 -m http.server</code> works) and visit the <code>index.html</code> page in your browser.
You should see the following in your JavaScript console:</p>
<pre class="z-code"><code><span class="z-text z-plain">Number from Rust: 42
</span><span class="z-text z-plain">1 + 2 = 3
</span></code></pre>
<p>What happened here is that the WebAssembly blob was fetched by the browser before being turned into an <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer"><code>ArrayBuffer</code></a> and fed into <code>WebAssembly.instantiate</code>.
The <code>instance</code> field of the result can then be used to call the Rust-defined <code>main</code> and <code>add</code> functions.<label for="note-1" class="margin-toggle sidenote-number"></label><input type="checkbox" id="note-1" class="margin-toggle"/><span class="sidenote">Not sure why <code>main</code> can get away without <code>#[no_mangle]</code> and <code>pub extern "C"</code> when <code>add</code> needs it.</span></p>
<p>The biggest benefit of using <code>WebAssembly.instantiate</code> is that it works in pretty much every browser that supports WebAssembly itself.
However, there's a downside:</p>
<blockquote>
<p><strong>Warning:</strong> This method is not the most efficient way of fetching and instantiating wasm modules.
If at all possible, you should use the newer <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/WebAssembly/instantiateStreaming"><code>WebAssembly.instantiateStreaming()</code></a> method instead,
which fetches, compiles, and instantiates a module all in one step, directly from the raw bytecode, so doesn't require conversion to an <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer"><code>ArrayBuffer</code></a>.</p>
<footer><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/WebAssembly/instantiate">WebAssembly.instantiate() - JavaScript | MDN</a></footer>
</blockquote>
<p>Which brings us to our next WebAssembly loading method...</p>
<h2 id="webassembly-instantiatestreaming"><a class="zola-anchor" href="#webassembly-instantiatestreaming" aria-label="Anchor link for: webassembly-instantiatestreaming">&num;</a>
<code>WebAssembly.instantiateStreaming</code></h2>
<p><a href="https://caniuse.com/mdn-javascript_builtins_webassembly_instantiatestreaming">https://caniuse.com/mdn-javascript_builtins_webassembly_instantiatestreaming</a></p>
<ul>
<li>Chrome 61: September 5, 2017</li>
<li>Firefox 58: January 23, 2018</li>
<li>Safari 15: September 20, 2021 (!!!)</li>
</ul>
<p>This approach is almost the same as using <code>WebAssembly.instantiate</code>, but the <code>fetch</code> block in JavaScript looks like this instead:</p>
<pre data-lang="javascript" class="language-javascript z-code"><code class="language-javascript" data-lang="javascript"><span class="z-source z-ts"><span class="z-meta z-function-call z-ts"><span class="z-entity z-name z-function z-ts">fetch</span></span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-string z-quoted z-single z-ts"><span class="z-punctuation z-definition z-string z-begin z-ts">&#39;</span>target/wasm32-unknown-unknown/release/wasm-instantiate.wasm<span class="z-punctuation z-definition z-string z-end z-ts">&#39;</span></span><span class="z-meta z-brace z-round z-ts">)</span>
</span><span class="z-source z-ts">  <span class="z-meta z-function-call z-ts"><span class="z-punctuation z-accessor z-ts">.</span><span class="z-support z-function z-promise z-ts">then</span></span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-meta z-arrow z-ts"><span class="z-meta z-parameters z-ts"><span class="z-punctuation z-definition z-parameters z-begin z-ts">(</span><span class="z-variable z-parameter z-ts">response</span><span class="z-punctuation z-definition z-parameters z-end z-ts">)</span></span> </span><span class="z-meta z-arrow z-ts"><span class="z-storage z-type z-function z-arrow z-ts">=&gt;</span> </span><span class="z-meta z-function-call z-ts"><span class="z-variable z-other z-object z-ts">WebAssembly</span><span class="z-punctuation z-accessor z-ts">.</span><span class="z-entity z-name z-function z-ts">instantiateStreaming</span></span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-variable z-other z-readwrite z-ts">response</span><span class="z-punctuation z-separator z-comma z-ts">,</span> <span class="z-variable z-other z-readwrite z-ts">imports</span><span class="z-meta z-brace z-round z-ts">)</span><span class="z-meta z-brace z-round z-ts">)</span>
</span><span class="z-source z-ts">  <span class="z-meta z-function-call z-ts"><span class="z-punctuation z-accessor z-ts">.</span><span class="z-support z-function z-promise z-ts">then</span></span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-meta z-arrow z-ts"><span class="z-meta z-parameters z-ts"><span class="z-punctuation z-definition z-parameters z-begin z-ts">(</span><span class="z-variable z-parameter z-ts">result</span><span class="z-punctuation z-definition z-parameters z-end z-ts">)</span></span> </span><span class="z-meta z-arrow z-ts"><span class="z-storage z-type z-function z-arrow z-ts">=&gt;</span> <span class="z-meta z-block z-ts"><span class="z-punctuation z-definition z-block z-ts">{</span>
</span></span></span><span class="z-source z-ts"><span class="z-meta z-arrow z-ts"><span class="z-meta z-block z-ts">    <span class="z-meta z-function-call z-ts"><span class="z-variable z-other z-object z-ts">result</span><span class="z-punctuation z-accessor z-ts">.</span><span class="z-variable z-other z-object z-property z-ts">instance</span><span class="z-punctuation z-accessor z-ts">.</span><span class="z-variable z-other z-object z-property z-ts">exports</span><span class="z-punctuation z-accessor z-ts">.</span><span class="z-entity z-name z-function z-ts">main</span></span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-meta z-brace z-round z-ts">)</span><span class="z-punctuation z-terminator z-statement z-ts">;</span>
</span></span></span><span class="z-source z-ts"><span class="z-meta z-arrow z-ts"><span class="z-meta z-block z-ts">    <span class="z-meta z-var z-expr z-ts"><span class="z-storage z-type z-ts">const</span> <span class="z-meta z-var-single-variable z-expr z-ts"><span class="z-meta z-definition z-variable z-ts"><span class="z-variable z-other z-constant z-ts">sum</span></span> </span><span class="z-keyword z-operator z-assignment z-ts">=</span> <span class="z-meta z-function-call z-ts"><span class="z-variable z-other z-object z-ts">result</span><span class="z-punctuation z-accessor z-ts">.</span><span class="z-variable z-other z-object z-property z-ts">instance</span><span class="z-punctuation z-accessor z-ts">.</span><span class="z-variable z-other z-object z-property z-ts">exports</span><span class="z-punctuation z-accessor z-ts">.</span><span class="z-support z-function z-dom z-ts">add</span></span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-constant z-numeric z-decimal z-ts">1</span><span class="z-punctuation z-separator z-comma z-ts">,</span> <span class="z-constant z-numeric z-decimal z-ts">2</span><span class="z-meta z-brace z-round z-ts">)</span></span><span class="z-punctuation z-terminator z-statement z-ts">;</span>
</span></span></span><span class="z-source z-ts"><span class="z-meta z-arrow z-ts"><span class="z-meta z-block z-ts">    <span class="z-meta z-function-call z-ts"><span class="z-support z-class z-console z-ts">console</span><span class="z-punctuation z-accessor z-ts">.</span><span class="z-support z-function z-console z-ts">log</span></span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-string z-template z-ts"><span class="z-punctuation z-definition z-string z-template z-begin z-ts">`</span>1 + 2 = <span class="z-meta z-template z-expression z-ts"><span class="z-punctuation z-definition z-template-expression z-begin z-ts">${</span></span><span class="z-meta z-template z-expression z-ts"><span class="z-meta z-embedded z-line z-ts"><span class="z-variable z-other z-readwrite z-ts">sum</span></span><span class="z-punctuation z-definition z-template-expression z-end z-ts">}</span></span><span class="z-punctuation z-definition z-string z-template z-end z-ts">`</span></span><span class="z-meta z-brace z-round z-ts">)</span><span class="z-punctuation z-terminator z-statement z-ts">;</span>
</span></span></span><span class="z-source z-ts"><span class="z-meta z-arrow z-ts"><span class="z-meta z-block z-ts">  <span class="z-punctuation z-definition z-block z-ts">}</span></span></span><span class="z-meta z-brace z-round z-ts">)</span><span class="z-punctuation z-terminator z-statement z-ts">;</span>
</span></code></pre>
<p>That is, <code>WebAssembly.instantiateStreaming</code> replaces the <code>arrayBuffer</code> and <code>WebAssembly.instantiate</code> calls.
The benefits of this are described in the quote in the previous section.</p>
<p>Safari took a whopping four years to support this over plain <code>WebAssembly.instantiate</code>!</p>
<h2 id="wasm-bindgen-target-no-modules"><a class="zola-anchor" href="#wasm-bindgen-target-no-modules" aria-label="Anchor link for: wasm-bindgen-target-no-modules">&num;</a>
<code>wasm-bindgen --target no-modules</code></h2>
<p>This method uses <a href="https://caniuse.com/async-functions">async functions</a>, which are supported in all versions of Chrome, Firefox and Safari that also support WebAssembly.</p>
<p>So far we've been compiling and using raw WebAssembly from JavaScript.
As you may have noticed from the, uh, unambitious code samples, JavaScript can communicate with WebAssembly with numbers, peer into it's memory, and... not do much else.
It'd be nice to be able to send bigger things like strings back and forth between JavaScript and WebAssembly.</p>
<p>Enter <a href="https://rustwasm.github.io/docs/wasm-bindgen/"><code>wasm-bindgen</code></a>.
It allows us to write functions that accept things like strings and objects in Rust and call them directly on the JavaScript side.
Specifically, we'll want the <code>wasm-bindgen</code> command line utility:</p>
<pre class="z-code"><code><span class="z-text z-plain">cargo install wasm-bindgen-cli
</span></code></pre>
<p>Now start with a new Rust project; we'll be cribbing from <a href="https://rustwasm.github.io/docs/wasm-bindgen/examples/without-a-bundler.html">the <code>wasm-bindgen</code> Guide</a>:</p>
<pre class="z-code"><code><span class="z-text z-plain">cargo new --lib no-modules
</span></code></pre>
<details open><summary><code>no-modules/Cargo.toml</code>:</summary>
<pre data-lang="toml" class="language-toml z-code"><code class="language-toml" data-lang="toml"><span class="z-source z-toml"><span class="z-punctuation z-definition z-table z-begin z-toml">[</span><span class="z-meta z-tag z-table z-toml"><span class="z-entity z-name z-table z-toml">package</span></span><span class="z-punctuation z-definition z-table z-end z-toml">]</span>
</span><span class="z-source z-toml"><span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">name</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-string z-quoted z-double z-basic z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">&quot;</span>no-modules<span class="z-punctuation z-definition z-string z-end z-toml">&quot;</span></span>
</span><span class="z-source z-toml"><span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">version</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-string z-quoted z-double z-basic z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">&quot;</span>0.1.0<span class="z-punctuation z-definition z-string z-end z-toml">&quot;</span></span>
</span><span class="z-source z-toml"><span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">edition</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-string z-quoted z-double z-basic z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">&quot;</span>2021<span class="z-punctuation z-definition z-string z-end z-toml">&quot;</span></span>
</span><span class="z-source z-toml">
</span><span class="z-source z-toml"><span class="z-punctuation z-definition z-table z-begin z-toml">[</span><span class="z-meta z-tag z-table z-toml"><span class="z-entity z-name z-table z-toml">lib</span></span><span class="z-punctuation z-definition z-table z-end z-toml">]</span>
</span><span class="z-source z-toml"><span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">crate-type</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-punctuation z-definition z-array z-begin z-toml">[</span><span class="z-string z-quoted z-double z-basic z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">&quot;</span>cdylib<span class="z-punctuation z-definition z-string z-end z-toml">&quot;</span></span><span class="z-punctuation z-definition z-array z-end z-toml">]</span>
</span><span class="z-source z-toml">
</span><span class="z-source z-toml"><span class="z-punctuation z-definition z-table z-begin z-toml">[</span><span class="z-meta z-tag z-table z-toml"><span class="z-entity z-name z-table z-toml">dependencies</span></span><span class="z-punctuation z-definition z-table z-end z-toml">]</span>
</span><span class="z-source z-toml"><span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">wasm-bindgen</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-string z-quoted z-double z-basic z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">&quot;</span>0.2.82<span class="z-punctuation z-definition z-string z-end z-toml">&quot;</span></span>
</span><span class="z-source z-toml">
</span><span class="z-source z-toml"><span class="z-punctuation z-definition z-table z-begin z-toml">[</span><span class="z-meta z-tag z-table z-toml"><span class="z-entity z-name z-table z-toml">dependencies</span><span class="z-punctuation z-separator z-table z-toml">.</span><span class="z-entity z-name z-table z-toml">web-sys</span></span><span class="z-punctuation z-definition z-table z-end z-toml">]</span>
</span><span class="z-source z-toml"><span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">version</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-string z-quoted z-double z-basic z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">&quot;</span>0.3.59<span class="z-punctuation z-definition z-string z-end z-toml">&quot;</span></span>
</span><span class="z-source z-toml"><span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">features</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-punctuation z-definition z-array z-begin z-toml">[</span>
</span><span class="z-source z-toml">  <span class="z-string z-quoted z-single z-literal z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">&#39;</span>Document<span class="z-punctuation z-definition z-string z-end z-toml">&#39;</span></span><span class="z-punctuation z-separator z-array z-toml">,</span>
</span><span class="z-source z-toml">  <span class="z-string z-quoted z-single z-literal z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">&#39;</span>Element<span class="z-punctuation z-definition z-string z-end z-toml">&#39;</span></span><span class="z-punctuation z-separator z-array z-toml">,</span>
</span><span class="z-source z-toml">  <span class="z-string z-quoted z-single z-literal z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">&#39;</span>HtmlElement<span class="z-punctuation z-definition z-string z-end z-toml">&#39;</span></span><span class="z-punctuation z-separator z-array z-toml">,</span>
</span><span class="z-source z-toml">  <span class="z-string z-quoted z-single z-literal z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">&#39;</span>Node<span class="z-punctuation z-definition z-string z-end z-toml">&#39;</span></span><span class="z-punctuation z-separator z-array z-toml">,</span>
</span><span class="z-source z-toml">  <span class="z-string z-quoted z-single z-literal z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">&#39;</span>Window<span class="z-punctuation z-definition z-string z-end z-toml">&#39;</span></span><span class="z-punctuation z-separator z-array z-toml">,</span>
</span><span class="z-source z-toml"><span class="z-punctuation z-definition z-array z-end z-toml">]</span>
</span></code></pre>
</details>
<details open><summary><code>no-modules/src/lib.rs</code>:</summary>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">wasm_bindgen<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">prelude<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-keyword z-operator z-arithmetic z-rust">*</span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">wasm_bindgen</span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust">start</span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
</span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">main</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-&gt;</span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Result</span><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-punctuation z-section z-group z-end z-rust">)</span>, JsValue<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span></span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> window <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">web_sys<span class="z-punctuation z-accessor z-rust">::</span></span>window<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">expect</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>window<span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> document <span class="z-keyword z-operator z-assignment z-rust">=</span> window<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">document</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">expect</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>document in window<span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> body <span class="z-keyword z-operator z-assignment z-rust">=</span> document<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">body</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">expect</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>body in document<span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> val <span class="z-keyword z-operator z-assignment z-rust">=</span> document<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">create_element</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>p<span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-keyword z-operator z-rust">?</span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    val<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">set_inner_html</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>Hello from Rust!<span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    body<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">append_child</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&amp;</span>val</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-keyword z-operator z-rust">?</span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-support z-type z-rust">Ok</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">wasm_bindgen</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
</span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">add</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-variable z-parameter z-rust">a</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-type z-rust">u32</span>, <span class="z-variable z-parameter z-rust">b</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-type z-rust">u32</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-&gt;</span> <span class="z-storage z-type z-rust">u32</span></span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    a <span class="z-keyword z-operator z-arithmetic z-rust">+</span> b
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
</details>
<p>Compile it using <code>cargo</code>:</p>
<pre class="z-code"><code><span class="z-text z-plain">cargo build --release --target=wasm32-unknown-unknown
</span></code></pre>
<p>The resulting WebAssembly blob at <code>target/wasm32-unknown-unknown/release/no_modules.wasm</code><label for="note-2" class="margin-toggle sidenote-number"></label><input type="checkbox" id="note-2" class="margin-toggle"/><span class="sidenote">Not sure why <code>cargo</code> converted the dash in the package name into an underscore here, but not in the previous methods.</span> needs be run through the <code>wasm-bindgen</code> tool:</p>
<pre class="z-code"><code><span class="z-text z-plain">wasm-bindgen target/wasm32-unknown-unknown/release/no_modules.wasm \
</span><span class="z-text z-plain">    --out-dir .                                                    \
</span><span class="z-text z-plain">    --target no-modules                                            \
</span><span class="z-text z-plain">    --no-typescript
</span></code></pre>
<p>This should produce a <code>no_modules.js</code> file that our web page will load, as well as a <code>no_modules_bg.wasm</code> file that <code>no_modules.js</code> will load in turn.
Next, the web page itself.</p>
<details open><summary><code>no-modules/index.html</code>:</summary>
<pre data-lang="html" class="language-html z-code"><code class="language-html" data-lang="html"><span class="z-text z-html z-basic"><span class="z-meta z-tag z-sgml z-doctype z-html"><span class="z-punctuation z-definition z-tag z-begin z-html">&lt;!</span><span class="z-keyword z-declaration z-doctype z-html">DOCTYPE</span> <span class="z-constant z-language z-doctype z-html">html</span><span class="z-punctuation z-definition z-tag z-end z-html">&gt;</span></span>
</span><span class="z-text z-html z-basic"><span class="z-meta z-tag z-structure z-any z-html"><span class="z-punctuation z-definition z-tag z-begin z-html">&lt;</span><span class="z-entity z-name z-tag z-structure z-any z-html">html</span> <span class="z-meta z-attribute-with-value z-html"><span class="z-entity z-other z-attribute-name z-html">lang</span><span class="z-punctuation z-separator z-key-value z-html">=</span><span class="z-string z-quoted z-double z-html"><span class="z-punctuation z-definition z-string z-begin z-html">&quot;</span>en<span class="z-punctuation z-definition z-string z-end z-html">&quot;</span></span></span><span class="z-punctuation z-definition z-tag z-end z-html">&gt;</span></span>
</span><span class="z-text z-html z-basic">  <span class="z-meta z-tag z-structure z-any z-html"><span class="z-punctuation z-definition z-tag z-begin z-html">&lt;</span><span class="z-entity z-name z-tag z-structure z-any z-html">head</span><span class="z-punctuation z-definition z-tag z-end z-html">&gt;</span></span>
</span><span class="z-text z-html z-basic">    <span class="z-meta z-tag z-inline z-any z-html"><span class="z-punctuation z-definition z-tag z-begin z-html">&lt;</span><span class="z-entity z-name z-tag z-inline z-any z-html">meta</span> <span class="z-meta z-attribute-with-value z-html"><span class="z-entity z-other z-attribute-name z-html">charset</span><span class="z-punctuation z-separator z-key-value z-html">=</span><span class="z-string z-quoted z-double z-html"><span class="z-punctuation z-definition z-string z-begin z-html">&quot;</span>utf-8<span class="z-punctuation z-definition z-string z-end z-html">&quot;</span></span></span><span class="z-punctuation z-definition z-tag z-end z-html">&gt;</span></span>
</span><span class="z-text z-html z-basic">    <span class="z-meta z-tag z-inline z-any z-html"><span class="z-punctuation z-definition z-tag z-begin z-html">&lt;</span><span class="z-entity z-name z-tag z-inline z-any z-html">title</span><span class="z-punctuation z-definition z-tag z-end z-html">&gt;</span></span>Rust WASM Demo<span class="z-meta z-tag z-inline z-any z-html"><span class="z-punctuation z-definition z-tag z-begin z-html">&lt;/</span><span class="z-entity z-name z-tag z-inline z-any z-html">title</span><span class="z-punctuation z-definition z-tag z-end z-html">&gt;</span></span>
</span><span class="z-text z-html z-basic">  <span class="z-meta z-tag z-structure z-any z-html"><span class="z-punctuation z-definition z-tag z-begin z-html">&lt;/</span><span class="z-entity z-name z-tag z-structure z-any z-html">head</span><span class="z-punctuation z-definition z-tag z-end z-html">&gt;</span></span>
</span><span class="z-text z-html z-basic">  <span class="z-meta z-tag z-structure z-any z-html"><span class="z-punctuation z-definition z-tag z-begin z-html">&lt;</span><span class="z-entity z-name z-tag z-structure z-any z-html">body</span><span class="z-punctuation z-definition z-tag z-end z-html">&gt;</span></span>
</span><span class="z-text z-html z-basic">    <span class="z-meta z-tag z-script z-begin z-html"><span class="z-punctuation z-definition z-tag z-begin z-html">&lt;</span><span class="z-entity z-name z-tag z-script z-html">script</span></span><span class="z-meta z-tag z-script z-begin z-html"> <span class="z-meta z-attribute-with-value z-html"><span class="z-entity z-other z-attribute-name z-html">src</span><span class="z-punctuation z-separator z-key-value z-html">=</span><span class="z-string z-quoted z-double z-html"><span class="z-punctuation z-definition z-string z-begin z-html">&quot;</span>no_modules.js<span class="z-punctuation z-definition z-string z-end z-html">&quot;</span></span></span><span class="z-punctuation z-definition z-tag z-end z-html">&gt;</span></span><span class="z-meta z-tag z-script z-end z-html"><span class="z-punctuation z-definition z-tag z-begin z-html">&lt;/</span><span class="z-entity z-name z-tag z-script z-html">script</span><span class="z-punctuation z-definition z-tag z-end z-html">&gt;</span></span>
</span><span class="z-text z-html z-basic">    <span class="z-meta z-tag z-script z-begin z-html"><span class="z-punctuation z-definition z-tag z-begin z-html">&lt;</span><span class="z-entity z-name z-tag z-script z-html">script</span></span><span class="z-meta z-tag z-script z-begin z-html"><span class="z-punctuation z-definition z-tag z-end z-html">&gt;</span></span>
</span><span class="z-text z-html z-basic">      <span class="z-source z-js z-embedded z-html"><span class="z-source z-js"><span class="z-storage z-type z-js">const</span> <span class="z-meta z-binding z-destructuring z-mapping z-js"><span class="z-punctuation z-section z-block z-begin z-js">{</span> <span class="z-meta z-mapping z-key z-js"><span class="z-meta z-binding z-name z-js"><span class="z-variable z-other z-readwrite z-js">add</span></span> </span><span class="z-punctuation z-section z-block z-end z-js">}</span></span> <span class="z-keyword z-operator z-assignment z-js">=</span> <span class="z-variable z-other z-readwrite z-js">wasm_bindgen</span><span class="z-punctuation z-terminator z-statement z-js">;</span>
</span></span></span><span class="z-text z-html z-basic"><span class="z-source z-js z-embedded z-html"><span class="z-source z-js">
</span></span></span><span class="z-text z-html z-basic"><span class="z-source z-js z-embedded z-html"><span class="z-source z-js">      <span class="z-meta z-function z-js"></span><span class="z-meta z-function z-declaration z-js"><span class="z-storage z-type z-js">async</span> <span class="z-storage z-type z-function z-js">function</span> <span class="z-entity z-name z-function z-js">run</span><span class="z-punctuation z-section z-group z-begin z-js">(</span><span class="z-punctuation z-section z-group z-end z-js">)</span></span><span class="z-meta z-function z-js"> <span class="z-meta z-block z-js"><span class="z-punctuation z-section z-block z-begin z-js">{</span>
</span></span></span></span></span><span class="z-text z-html z-basic"><span class="z-source z-js z-embedded z-html"><span class="z-source z-js"><span class="z-meta z-function z-js"><span class="z-meta z-block z-js">        <span class="z-keyword z-control z-flow z-await z-js">await</span> <span class="z-meta z-function-call z-js"><span class="z-variable z-function z-js">wasm_bindgen</span><span class="z-meta z-group z-js"><span class="z-punctuation z-section z-group z-begin z-js">(</span><span class="z-meta z-string z-js"><span class="z-string z-quoted z-single z-js"><span class="z-punctuation z-definition z-string z-begin z-js">&#39;</span>./no_modules_bg.wasm<span class="z-punctuation z-definition z-string z-end z-js">&#39;</span></span></span><span class="z-punctuation z-section z-group z-end z-js">)</span></span></span><span class="z-punctuation z-terminator z-statement z-js">;</span>
</span></span></span></span></span><span class="z-text z-html z-basic"><span class="z-source z-js z-embedded z-html"><span class="z-source z-js"><span class="z-meta z-function z-js"><span class="z-meta z-block z-js">        <span class="z-storage z-type z-js">const</span> <span class="z-meta z-binding z-name z-js"><span class="z-variable z-other z-readwrite z-js">sum</span></span> <span class="z-keyword z-operator z-assignment z-js">=</span> <span class="z-meta z-function-call z-js"><span class="z-variable z-function z-js">add</span><span class="z-meta z-group z-js"><span class="z-punctuation z-section z-group z-begin z-js">(</span><span class="z-constant z-numeric z-integer z-decimal z-js">1</span><span class="z-punctuation z-separator z-comma z-js">,</span> <span class="z-constant z-numeric z-integer z-decimal z-js">2</span><span class="z-punctuation z-section z-group z-end z-js">)</span></span></span><span class="z-punctuation z-terminator z-statement z-js">;</span>
</span></span></span></span></span><span class="z-text z-html z-basic"><span class="z-source z-js z-embedded z-html"><span class="z-source z-js"><span class="z-meta z-function z-js"><span class="z-meta z-block z-js">        <span class="z-meta z-function-call z-method z-js"><span class="z-support z-type z-object z-console z-js">console</span><span class="z-punctuation z-accessor z-js">.</span><span class="z-support z-function z-console z-js">log</span><span class="z-meta z-group z-js"><span class="z-punctuation z-section z-group z-begin z-js">(</span><span class="z-meta z-string z-js"><span class="z-string z-quoted z-other z-js"><span class="z-punctuation z-definition z-string z-begin z-js">`</span>1 + 2 = </span><span class="z-meta z-interpolation z-js"><span class="z-punctuation z-section z-interpolation z-begin z-js">${</span></span><span class="z-meta z-interpolation z-js"><span class="z-source z-js z-embedded"><span class="z-variable z-other z-readwrite z-js">sum</span></span><span class="z-punctuation z-section z-interpolation z-end z-js">}</span></span><span class="z-string z-quoted z-other z-js"><span class="z-punctuation z-definition z-string z-end z-js">`</span></span></span><span class="z-punctuation z-section z-group z-end z-js">)</span></span></span><span class="z-punctuation z-terminator z-statement z-js">;</span>
</span></span></span></span></span><span class="z-text z-html z-basic"><span class="z-source z-js z-embedded z-html"><span class="z-source z-js"><span class="z-meta z-function z-js"><span class="z-meta z-block z-js">      <span class="z-punctuation z-section z-block z-end z-js">}</span></span></span>
</span></span></span><span class="z-text z-html z-basic"><span class="z-source z-js z-embedded z-html"><span class="z-source z-js">
</span></span></span><span class="z-text z-html z-basic"><span class="z-source z-js z-embedded z-html"><span class="z-source z-js">      <span class="z-meta z-function-call z-js"><span class="z-variable z-function z-js">run</span><span class="z-meta z-group z-js"><span class="z-punctuation z-section z-group z-begin z-js">(</span><span class="z-punctuation z-section z-group z-end z-js">)</span></span></span><span class="z-punctuation z-terminator z-statement z-js">;</span>
</span></span></span><span class="z-text z-html z-basic"><span class="z-source z-js z-embedded z-html"><span class="z-source z-js">    </span></span><span class="z-meta z-tag z-script z-end z-html"><span class="z-punctuation z-definition z-tag z-begin z-html">&lt;/</span><span class="z-entity z-name z-tag z-script z-html">script</span><span class="z-punctuation z-definition z-tag z-end z-html">&gt;</span></span>
</span><span class="z-text z-html z-basic">  <span class="z-meta z-tag z-structure z-any z-html"><span class="z-punctuation z-definition z-tag z-begin z-html">&lt;/</span><span class="z-entity z-name z-tag z-structure z-any z-html">body</span><span class="z-punctuation z-definition z-tag z-end z-html">&gt;</span></span>
</span><span class="z-text z-html z-basic"><span class="z-meta z-tag z-structure z-any z-html"><span class="z-punctuation z-definition z-tag z-begin z-html">&lt;/</span><span class="z-entity z-name z-tag z-structure z-any z-html">html</span><span class="z-punctuation z-definition z-tag z-end z-html">&gt;</span></span>
</span></code></pre>
</details>
<p>Loading this should show "Hello from Rust!" in the browser, and the following in the JavaScript console:</p>
<pre class="z-code"><code><span class="z-text z-plain">1 + 2 = 3
</span></code></pre>
<p>Loading the <code>no_modules.js</code> file in a <code>&lt;script&gt;</code> tag creates a global <code>wasm_bindgen</code> variable that's both a function and an object with properties.
Calling <code>wasm_bindgen</code> as a function acts like calling the <code>main</code> function in Rust, since it was annotated with <code>#[wasm_bindgen(start)]</code>.
Other functions annotated with just <code>#[wasm_bindgen]</code> like our <code>add</code> Rust function exist as properties on the <code>wasm_bindgen</code> object.</p>
<h2 id="wasm-bindgen-target-web"><a class="zola-anchor" href="#wasm-bindgen-target-web" aria-label="Anchor link for: wasm-bindgen-target-web">&num;</a>
<code>wasm-bindgen --target web</code></h2>
<p><a href="https://caniuse.com/es6-module">https://caniuse.com/es6-module</a></p>
<ul>
<li>Chrome 61: September 5, 2017</li>
<li>Firefox 60: May 9, 2018</li>
<li>Safari 11: September 19, 2017</li>
</ul>
<p>This form of WebAssembly loading makes use of <code>&lt;script type="module"&gt;</code>.
As you might have guessed, this time we'll be using the <code>wasm-bindgen</code> tool to produce a <em>module</em> that the web browser will load.</p>
<p>Start a new Rust project:</p>
<pre class="z-code"><code><span class="z-text z-plain">cargo new --lib web
</span></code></pre>
<details open><summary><code>web/Cargo.toml</code>:</summary>
<pre data-lang="toml" class="language-toml z-code"><code class="language-toml" data-lang="toml"><span class="z-source z-toml"><span class="z-punctuation z-definition z-table z-begin z-toml">[</span><span class="z-meta z-tag z-table z-toml"><span class="z-entity z-name z-table z-toml">package</span></span><span class="z-punctuation z-definition z-table z-end z-toml">]</span>
</span><span class="z-source z-toml"><span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">name</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-string z-quoted z-double z-basic z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">&quot;</span>web<span class="z-punctuation z-definition z-string z-end z-toml">&quot;</span></span>
</span><span class="z-source z-toml"><span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">version</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-string z-quoted z-double z-basic z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">&quot;</span>0.1.0<span class="z-punctuation z-definition z-string z-end z-toml">&quot;</span></span>
</span><span class="z-source z-toml"><span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">edition</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-string z-quoted z-double z-basic z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">&quot;</span>2021<span class="z-punctuation z-definition z-string z-end z-toml">&quot;</span></span>
</span><span class="z-source z-toml">
</span><span class="z-source z-toml"><span class="z-punctuation z-definition z-table z-begin z-toml">[</span><span class="z-meta z-tag z-table z-toml"><span class="z-entity z-name z-table z-toml">lib</span></span><span class="z-punctuation z-definition z-table z-end z-toml">]</span>
</span><span class="z-source z-toml"><span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">crate-type</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-punctuation z-definition z-array z-begin z-toml">[</span><span class="z-string z-quoted z-double z-basic z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">&quot;</span>cdylib<span class="z-punctuation z-definition z-string z-end z-toml">&quot;</span></span><span class="z-punctuation z-definition z-array z-end z-toml">]</span>
</span><span class="z-source z-toml">
</span><span class="z-source z-toml"><span class="z-punctuation z-definition z-table z-begin z-toml">[</span><span class="z-meta z-tag z-table z-toml"><span class="z-entity z-name z-table z-toml">dependencies</span></span><span class="z-punctuation z-definition z-table z-end z-toml">]</span>
</span><span class="z-source z-toml"><span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">wasm-bindgen</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-string z-quoted z-double z-basic z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">&quot;</span>0.2.82<span class="z-punctuation z-definition z-string z-end z-toml">&quot;</span></span>
</span><span class="z-source z-toml">
</span><span class="z-source z-toml"><span class="z-punctuation z-definition z-table z-begin z-toml">[</span><span class="z-meta z-tag z-table z-toml"><span class="z-entity z-name z-table z-toml">dependencies</span><span class="z-punctuation z-separator z-table z-toml">.</span><span class="z-entity z-name z-table z-toml">web-sys</span></span><span class="z-punctuation z-definition z-table z-end z-toml">]</span>
</span><span class="z-source z-toml"><span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">version</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-string z-quoted z-double z-basic z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">&quot;</span>0.3.59<span class="z-punctuation z-definition z-string z-end z-toml">&quot;</span></span>
</span><span class="z-source z-toml"><span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">features</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-punctuation z-definition z-array z-begin z-toml">[</span>
</span><span class="z-source z-toml">    <span class="z-string z-quoted z-single z-literal z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">&#39;</span>Document<span class="z-punctuation z-definition z-string z-end z-toml">&#39;</span></span><span class="z-punctuation z-separator z-array z-toml">,</span>
</span><span class="z-source z-toml">    <span class="z-string z-quoted z-single z-literal z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">&#39;</span>Element<span class="z-punctuation z-definition z-string z-end z-toml">&#39;</span></span><span class="z-punctuation z-separator z-array z-toml">,</span>
</span><span class="z-source z-toml">    <span class="z-string z-quoted z-single z-literal z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">&#39;</span>HtmlElement<span class="z-punctuation z-definition z-string z-end z-toml">&#39;</span></span><span class="z-punctuation z-separator z-array z-toml">,</span>
</span><span class="z-source z-toml">    <span class="z-string z-quoted z-single z-literal z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">&#39;</span>Node<span class="z-punctuation z-definition z-string z-end z-toml">&#39;</span></span><span class="z-punctuation z-separator z-array z-toml">,</span>
</span><span class="z-source z-toml">    <span class="z-string z-quoted z-single z-literal z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">&#39;</span>Window<span class="z-punctuation z-definition z-string z-end z-toml">&#39;</span></span><span class="z-punctuation z-separator z-array z-toml">,</span>
</span><span class="z-source z-toml"><span class="z-punctuation z-definition z-array z-end z-toml">]</span>
</span></code></pre>
</details>
<p>The <code>web/src/lib.rs</code> file is identical to <code>no-modules/src/lib.rs</code> from the <code>wasm-bindgen --target no-modules</code> section, so copy it over now.</p>
<p>Build the Rust code the same way:</p>
<pre class="z-code"><code><span class="z-text z-plain">cargo build --release --target=wasm32-unknown-unknown
</span></code></pre>
<p>We'll use the <code>wasm-bindgen</code> tool again, but this time we'll pass <code>--target web</code> to create a module:</p>
<pre class="z-code"><code><span class="z-text z-plain">wasm-bindgen target/wasm32-unknown-unknown/release/web.wasm \
</span><span class="z-text z-plain">    --out-dir .                                             \
</span><span class="z-text z-plain">    --target web                                            \
</span><span class="z-text z-plain">    --no-typescript
</span></code></pre>
<p>Again, we get <code>web.js</code> and <code>web_bg.wasm</code> files.
We want to load the <code>web.js</code> in our web page.</p>
<details open><summary><code>web/index.html</code>:</summary>
<pre data-lang="html" class="language-html z-code"><code class="language-html" data-lang="html"><span class="z-text z-html z-basic"><span class="z-meta z-tag z-sgml z-doctype z-html"><span class="z-punctuation z-definition z-tag z-begin z-html">&lt;!</span><span class="z-keyword z-declaration z-doctype z-html">DOCTYPE</span> <span class="z-constant z-language z-doctype z-html">html</span><span class="z-punctuation z-definition z-tag z-end z-html">&gt;</span></span>
</span><span class="z-text z-html z-basic"><span class="z-meta z-tag z-structure z-any z-html"><span class="z-punctuation z-definition z-tag z-begin z-html">&lt;</span><span class="z-entity z-name z-tag z-structure z-any z-html">html</span> <span class="z-meta z-attribute-with-value z-html"><span class="z-entity z-other z-attribute-name z-html">lang</span><span class="z-punctuation z-separator z-key-value z-html">=</span><span class="z-string z-quoted z-double z-html"><span class="z-punctuation z-definition z-string z-begin z-html">&quot;</span>en<span class="z-punctuation z-definition z-string z-end z-html">&quot;</span></span></span><span class="z-punctuation z-definition z-tag z-end z-html">&gt;</span></span>
</span><span class="z-text z-html z-basic">  <span class="z-meta z-tag z-structure z-any z-html"><span class="z-punctuation z-definition z-tag z-begin z-html">&lt;</span><span class="z-entity z-name z-tag z-structure z-any z-html">head</span><span class="z-punctuation z-definition z-tag z-end z-html">&gt;</span></span>
</span><span class="z-text z-html z-basic">    <span class="z-meta z-tag z-inline z-any z-html"><span class="z-punctuation z-definition z-tag z-begin z-html">&lt;</span><span class="z-entity z-name z-tag z-inline z-any z-html">meta</span> <span class="z-meta z-attribute-with-value z-html"><span class="z-entity z-other z-attribute-name z-html">charset</span><span class="z-punctuation z-separator z-key-value z-html">=</span><span class="z-string z-quoted z-double z-html"><span class="z-punctuation z-definition z-string z-begin z-html">&quot;</span>utf-8<span class="z-punctuation z-definition z-string z-end z-html">&quot;</span></span></span><span class="z-punctuation z-definition z-tag z-end z-html">&gt;</span></span>
</span><span class="z-text z-html z-basic">    <span class="z-meta z-tag z-inline z-any z-html"><span class="z-punctuation z-definition z-tag z-begin z-html">&lt;</span><span class="z-entity z-name z-tag z-inline z-any z-html">title</span><span class="z-punctuation z-definition z-tag z-end z-html">&gt;</span></span>Rust WASM Demo<span class="z-meta z-tag z-inline z-any z-html"><span class="z-punctuation z-definition z-tag z-begin z-html">&lt;/</span><span class="z-entity z-name z-tag z-inline z-any z-html">title</span><span class="z-punctuation z-definition z-tag z-end z-html">&gt;</span></span>
</span><span class="z-text z-html z-basic">  <span class="z-meta z-tag z-structure z-any z-html"><span class="z-punctuation z-definition z-tag z-begin z-html">&lt;/</span><span class="z-entity z-name z-tag z-structure z-any z-html">head</span><span class="z-punctuation z-definition z-tag z-end z-html">&gt;</span></span>
</span><span class="z-text z-html z-basic">  <span class="z-meta z-tag z-structure z-any z-html"><span class="z-punctuation z-definition z-tag z-begin z-html">&lt;</span><span class="z-entity z-name z-tag z-structure z-any z-html">body</span><span class="z-punctuation z-definition z-tag z-end z-html">&gt;</span></span>
</span><span class="z-text z-html z-basic">    <span class="z-meta z-tag z-script z-begin z-html"><span class="z-punctuation z-definition z-tag z-begin z-html">&lt;</span><span class="z-entity z-name z-tag z-script z-html">script</span></span><span class="z-meta z-tag z-script z-begin z-html"> <span class="z-meta z-attribute-with-value z-html"><span class="z-entity z-other z-attribute-name z-html">type</span></span></span><span class="z-meta z-tag z-script z-begin z-html"><span class="z-meta z-attribute-with-value z-html"><span class="z-punctuation z-separator z-key-value z-html">=</span></span></span><span class="z-meta z-tag z-script z-begin z-html"><span class="z-meta z-attribute-with-value z-html"></span></span><span class="z-meta z-tag z-script z-begin z-html"><span class="z-meta z-attribute-with-value z-html"><span class="z-string z-quoted z-double z-html"><span class="z-punctuation z-definition z-string z-begin z-html">&quot;</span>module<span class="z-punctuation z-definition z-string z-end z-html">&quot;</span></span></span><span class="z-punctuation z-definition z-tag z-end z-html">&gt;</span></span>
</span><span class="z-text z-html z-basic">      <span class="z-source z-js z-embedded z-html"><span class="z-source z-js"><span class="z-meta z-import z-js"><span class="z-keyword z-control z-import-export z-js">import</span> </span><span class="z-meta z-import z-js"><span class="z-variable z-other z-readwrite z-js">init</span><span class="z-punctuation z-separator z-comma z-js">,</span> <span class="z-meta z-block z-js"><span class="z-punctuation z-section z-block z-begin z-js">{</span> <span class="z-variable z-other z-readwrite z-js">add</span> <span class="z-punctuation z-section z-block z-end z-js">}</span></span> <span class="z-keyword z-control z-import-export z-js">from</span> <span class="z-meta z-string z-js"><span class="z-string z-quoted z-single z-js"><span class="z-punctuation z-definition z-string z-begin z-js">&#39;</span>./web.js<span class="z-punctuation z-definition z-string z-end z-js">&#39;</span></span></span><span class="z-punctuation z-terminator z-statement z-js">;</span></span>
</span></span></span><span class="z-text z-html z-basic"><span class="z-source z-js z-embedded z-html"><span class="z-source z-js">
</span></span></span><span class="z-text z-html z-basic"><span class="z-source z-js z-embedded z-html"><span class="z-source z-js">      <span class="z-meta z-function z-js"></span><span class="z-meta z-function z-declaration z-js"><span class="z-storage z-type z-js">async</span> <span class="z-storage z-type z-function z-js">function</span> <span class="z-entity z-name z-function z-js">run</span><span class="z-punctuation z-section z-group z-begin z-js">(</span><span class="z-punctuation z-section z-group z-end z-js">)</span></span><span class="z-meta z-function z-js"> <span class="z-meta z-block z-js"><span class="z-punctuation z-section z-block z-begin z-js">{</span>
</span></span></span></span></span><span class="z-text z-html z-basic"><span class="z-source z-js z-embedded z-html"><span class="z-source z-js"><span class="z-meta z-function z-js"><span class="z-meta z-block z-js">        <span class="z-keyword z-control z-flow z-await z-js">await</span> <span class="z-meta z-function-call z-js"><span class="z-variable z-function z-js">init</span><span class="z-meta z-group z-js"><span class="z-punctuation z-section z-group z-begin z-js">(</span><span class="z-punctuation z-section z-group z-end z-js">)</span></span></span><span class="z-punctuation z-terminator z-statement z-js">;</span>
</span></span></span></span></span><span class="z-text z-html z-basic"><span class="z-source z-js z-embedded z-html"><span class="z-source z-js"><span class="z-meta z-function z-js"><span class="z-meta z-block z-js">        <span class="z-storage z-type z-js">const</span> <span class="z-meta z-binding z-name z-js"><span class="z-variable z-other z-readwrite z-js">sum</span></span> <span class="z-keyword z-operator z-assignment z-js">=</span> <span class="z-meta z-function-call z-js"><span class="z-variable z-function z-js">add</span><span class="z-meta z-group z-js"><span class="z-punctuation z-section z-group z-begin z-js">(</span><span class="z-constant z-numeric z-integer z-decimal z-js">1</span><span class="z-punctuation z-separator z-comma z-js">,</span> <span class="z-constant z-numeric z-integer z-decimal z-js">2</span><span class="z-punctuation z-section z-group z-end z-js">)</span></span></span><span class="z-punctuation z-terminator z-statement z-js">;</span>
</span></span></span></span></span><span class="z-text z-html z-basic"><span class="z-source z-js z-embedded z-html"><span class="z-source z-js"><span class="z-meta z-function z-js"><span class="z-meta z-block z-js">        <span class="z-meta z-function-call z-method z-js"><span class="z-support z-type z-object z-console z-js">console</span><span class="z-punctuation z-accessor z-js">.</span><span class="z-support z-function z-console z-js">log</span><span class="z-meta z-group z-js"><span class="z-punctuation z-section z-group z-begin z-js">(</span><span class="z-meta z-string z-js"><span class="z-string z-quoted z-other z-js"><span class="z-punctuation z-definition z-string z-begin z-js">`</span>1 + 2 = </span><span class="z-meta z-interpolation z-js"><span class="z-punctuation z-section z-interpolation z-begin z-js">${</span></span><span class="z-meta z-interpolation z-js"><span class="z-source z-js z-embedded"><span class="z-variable z-other z-readwrite z-js">sum</span></span><span class="z-punctuation z-section z-interpolation z-end z-js">}</span></span><span class="z-string z-quoted z-other z-js"><span class="z-punctuation z-definition z-string z-end z-js">`</span></span></span><span class="z-punctuation z-section z-group z-end z-js">)</span></span></span><span class="z-punctuation z-terminator z-statement z-js">;</span>
</span></span></span></span></span><span class="z-text z-html z-basic"><span class="z-source z-js z-embedded z-html"><span class="z-source z-js"><span class="z-meta z-function z-js"><span class="z-meta z-block z-js">      <span class="z-punctuation z-section z-block z-end z-js">}</span></span></span>
</span></span></span><span class="z-text z-html z-basic"><span class="z-source z-js z-embedded z-html"><span class="z-source z-js">
</span></span></span><span class="z-text z-html z-basic"><span class="z-source z-js z-embedded z-html"><span class="z-source z-js">      <span class="z-meta z-function-call z-js"><span class="z-variable z-function z-js">run</span><span class="z-meta z-group z-js"><span class="z-punctuation z-section z-group z-begin z-js">(</span><span class="z-punctuation z-section z-group z-end z-js">)</span></span></span><span class="z-punctuation z-terminator z-statement z-js">;</span>
</span></span></span><span class="z-text z-html z-basic"><span class="z-source z-js z-embedded z-html"><span class="z-source z-js">    </span></span><span class="z-meta z-tag z-script z-end z-html"><span class="z-punctuation z-definition z-tag z-begin z-html">&lt;/</span><span class="z-entity z-name z-tag z-script z-html">script</span><span class="z-punctuation z-definition z-tag z-end z-html">&gt;</span></span>
</span><span class="z-text z-html z-basic">  <span class="z-meta z-tag z-structure z-any z-html"><span class="z-punctuation z-definition z-tag z-begin z-html">&lt;/</span><span class="z-entity z-name z-tag z-structure z-any z-html">body</span><span class="z-punctuation z-definition z-tag z-end z-html">&gt;</span></span>
</span><span class="z-text z-html z-basic"><span class="z-meta z-tag z-structure z-any z-html"><span class="z-punctuation z-definition z-tag z-begin z-html">&lt;/</span><span class="z-entity z-name z-tag z-structure z-any z-html">html</span><span class="z-punctuation z-definition z-tag z-end z-html">&gt;</span></span>
</span></code></pre>
</details>
<p>Running a local web server and viewing this in your web browser should once again show "Hello from Rust!" and the following in the JavaScript console:</p>
<pre class="z-code"><code><span class="z-text z-plain">1 + 2 = 3
</span></code></pre>
<p><code>web.js</code> is now a module, so <code>init</code> is the handle to the <code>#[wasm_bindgen(start)]</code>-annotated <code>main</code> Rust function, and the <code>#[wasm_bindgen]</code>-annotated <code>add</code> Rust function is exported as expected.</p>
<h2 id="module-with-top-level-await"><a class="zola-anchor" href="#module-with-top-level-await" aria-label="Anchor link for: module-with-top-level-await">&num;</a>
Module with Top-Level <code>await</code></h2>
<p><a href="https://caniuse.com/mdn-javascript_operators_await_top_level">https://caniuse.com/mdn-javascript_operators_await_top_level</a></p>
<ul>
<li>Chrome 89: March 1, 2021 (!!!)</li>
<li>Firefox 89: June 1, 2021 (!!!)</li>
<li>Safari 15: September 20, 2021 (!!!)</li>
</ul>
<p>This is a slight tweak to the JavaScript code inside the <code>&lt;script type="module"&gt;</code> in the web page:</p>
<pre data-lang="javascript" class="language-javascript z-code"><code class="language-javascript" data-lang="javascript"><span class="z-source z-ts"><span class="z-meta z-import z-ts"><span class="z-keyword z-control z-import z-ts">import</span> <span class="z-variable z-other z-readwrite z-alias z-ts">init</span><span class="z-punctuation z-separator z-comma z-ts">,</span> <span class="z-meta z-block z-ts"><span class="z-punctuation z-definition z-block z-ts">{</span> <span class="z-variable z-other z-readwrite z-alias z-ts">add</span> <span class="z-punctuation z-definition z-block z-ts">}</span></span> <span class="z-keyword z-control z-from z-ts">from</span> <span class="z-string z-quoted z-single z-ts"><span class="z-punctuation z-definition z-string z-begin z-ts">&#39;</span>./web.js<span class="z-punctuation z-definition z-string z-end z-ts">&#39;</span></span></span><span class="z-punctuation z-terminator z-statement z-ts">;</span>
</span><span class="z-source z-ts"><span class="z-keyword z-control z-flow z-ts">await</span> <span class="z-meta z-function-call z-ts"><span class="z-entity z-name z-function z-ts">init</span></span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-meta z-brace z-round z-ts">)</span><span class="z-punctuation z-terminator z-statement z-ts">;</span>
</span><span class="z-source z-ts"><span class="z-meta z-var z-expr z-ts"><span class="z-storage z-type z-ts">const</span> <span class="z-meta z-var-single-variable z-expr z-ts"><span class="z-meta z-definition z-variable z-ts"><span class="z-variable z-other z-constant z-ts">sum</span></span> </span><span class="z-keyword z-operator z-assignment z-ts">=</span> <span class="z-meta z-function-call z-ts"><span class="z-entity z-name z-function z-ts">add</span></span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-constant z-numeric z-decimal z-ts">1</span><span class="z-punctuation z-separator z-comma z-ts">,</span> <span class="z-constant z-numeric z-decimal z-ts">2</span><span class="z-meta z-brace z-round z-ts">)</span></span><span class="z-punctuation z-terminator z-statement z-ts">;</span>
</span><span class="z-source z-ts"><span class="z-meta z-function-call z-ts"><span class="z-support z-class z-console z-ts">console</span><span class="z-punctuation z-accessor z-ts">.</span><span class="z-support z-function z-console z-ts">log</span></span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-string z-template z-ts"><span class="z-punctuation z-definition z-string z-template z-begin z-ts">`</span>1 + 2 = <span class="z-meta z-template z-expression z-ts"><span class="z-punctuation z-definition z-template-expression z-begin z-ts">${</span></span><span class="z-meta z-template z-expression z-ts"><span class="z-meta z-embedded z-line z-ts"><span class="z-variable z-other z-readwrite z-ts">sum</span></span><span class="z-punctuation z-definition z-template-expression z-end z-ts">}</span></span><span class="z-punctuation z-definition z-string z-template z-end z-ts">`</span></span><span class="z-meta z-brace z-round z-ts">)</span><span class="z-punctuation z-terminator z-statement z-ts">;</span>
</span></code></pre>
<p>This saves a bit of typing, but requires support for <code>await</code> at the JavaScript top level, which isn't supported for browsers stuck in the 3-4 year gap between 2017 and 2021.</p>
<h2 id="conclusion"><a class="zola-anchor" href="#conclusion" aria-label="Anchor link for: conclusion">&num;</a>
Conclusion</h2>
<p>If you only need to load raw WebAssembly, <code>WebAssembly.instantiateStreaming</code> is only newer than <code>WebAssembly.instantiate</code> by months, except for Safari, which lags by years.</p>
<p>For the enhancements provided by <code>wasm-bindgen</code>, <code>--target no-modules</code> has maximum compatibility, and <code>--target web</code> is only newer by months.
There's a big multi-year gap for top level <code>await</code> support; use it at your own peril.</p>

    
      <br><br>
      <p>Discussions:
        
          <a href="https://reddit.com/r/rust/comments/wgpg88/rust_and_webassembly_without_a_bundler/">&#x2F;r&#x2F;rust</a>
      </p>
    
  </article>
  <nav class="bottom-nav">
    
    
    
    <p><a href="..">&LeftArrow; More Posts</a></p>
  </nav>

  <footer>
    Made with <a href="https://www.getzola.org">Zola</a>.
  </footer>
</body>

</html>

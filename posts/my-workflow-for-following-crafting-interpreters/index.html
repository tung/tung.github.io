<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="description" content="Programming, game development and other technical tidbits">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>My Workflow for following Crafting Interpreters | Tung&#x27;s Word Box</title>
  <link rel="icon" href="https://tung.github.io/favicon.png" type="image/png" sizes="any">
  <link rel="stylesheet" href="https://tung.github.io/tufte.css">
  <link rel="stylesheet" href="https://tung.github.io/site.css">
  
    <link rel="alternate" type="application/atom+xml" title="Tung&#x27;s Word Box" href="https://tung.github.io/atom.xml">
  
</head>

<body>
  <header>
    <div class="home">
      <a href="https://tung.github.io">Tung&#x27;s Word Box</a>
    </div>
    <nav>
      <a href="https://tung.github.io/posts/">Posts</a>
      <a href="https://tung.github.io/tags/">Tags</a>
      <a href="https://tung.github.io/projects/">Projects</a>
      <a href="https://github.com/tung">GitHub</a>
      <a href="https://tungtn.itch.io">itch.io</a>
    </nav>
    <div style="clear: both"></div>
  </header>

  
  <h1>My Workflow for following Crafting Interpreters</h1>
  <article>
    
    
    <p class="meta">
        Posted on 2022-12-24, 
        Updated 2022-12-26; 
        Tags:
        <span class="tags">
              <a href="https://tung.github.io/tags/c/">c</a>,
              <a href="https://tung.github.io/tags/linux/">linux</a>,
              <a href="https://tung.github.io/tags/make/">make</a>,
              <a href="https://tung.github.io/tags/programming/">programming</a>,
              <a href="https://tung.github.io/tags/testing/">testing</a>
        </span>
    </p>
    <br>
    <p>I recently worked my way through Robert Nystrom's <a href="https://craftinginterpreters.com"><em>Crafting Interpreters</em></a>, which guides you through the process of making an interpreter for a scripting language.
The book is made up of three parts: a short part describing Lox (the scripting language made for the book), a tree-walk interpreter written in Java and a bytecode virtual machine interpreter written in C.
This post is about how I approached the last part.</p>
<p>The book doesn't recommend any specific setup or workflow, so you're free to go with whatever you like.
The rest of this post describes what I went with; all of the code can be found here: <a href="https://github.com/tung/clox">https://github.com/tung/clox</a></p>
<span id="continue-reading"></span><h2 id="goals"><a class="zola-anchor" href="#goals" aria-label="Anchor link for: goals">&num;</a>
Goals</h2>
<p><em>Crafting Interpreters</em> has every line of code needed to create <em>clox</em>, the C bytecode VM for the Lox language, and it'd be easy to just type it all in and nod along.
However, I wanted to go a little further, so I set a couple of extra goals for myself:</p>
<ul>
<li>Come up with a good testing workflow.</li>
<li>Learn about and integrate tools to support code quality, e.g. <abbr title="Language Server Protocol">LSP</abbr> server, automatic formatting, code coverage.</li>
</ul>
<h2 id="the-setup"><a class="zola-anchor" href="#the-setup" aria-label="Anchor link for: the-setup">&num;</a>
The Setup</h2>
<p>I run Linux and prefer a command-line-centered approach for small-to-medium-sized projects like these, so my basic setup looked like this:</p>
<ul>
<li>C compiler - <strong>GCC</strong>.</li>
<li>Build system - <strong>GNU Make</strong> with some <strong>GNU Bash</strong> to back it up.</li>
<li>Code editor - <a href="https://helix-editor.com"><strong>Helix</strong></a>, an up-and-coming editor with out-of-the-box LSP support.</li>
<li>Version control - <strong>Git</strong>.</li>
</ul>
<p>Along the way I pulled some extra tools into the fray:</p>
<ul>
<li>LSP server - <a href="https://clangd.llvm.org/"><strong>clangd</strong></a>, which Helix picks up right away.</li>
<li><code>compile_commands.json</code> generator for the LSP server - <a href="https://github.com/rizsotto/Bear"><strong>Bear</strong></a>.</li>
<li>Automatic code formatter - <a href="https://clang.llvm.org/docs/ClangFormat.html"><strong>clang-format</strong></a>.</li>
<li>Code coverage report generator - <a href="https://gcovr.com"><strong>gcovr</strong></a>.</li>
</ul>
<h2 id="editing-code-with-helix"><a class="zola-anchor" href="#editing-code-with-helix" aria-label="Anchor link for: editing-code-with-helix">&num;</a>
Editing Code with Helix</h2>
<p><a href="https://helix-editor.com"><strong>Helix</strong></a> is a modern modal text editor with out-of-the-box LSP support and <a href="https://tree-sitter.github.io/tree-sitter/">Tree-sitter</a>-powered highlighting and navigation.
As a long-time Vim user, it took me a couple of weeks to get used to it, but it was refresing to use an editor without spending hours figuring out how to integrate external tools I wanted to use.
The LSP support highlights warnings and errors as you type so you can deal with them right away.</p>
<p>I never thought setting up fuzzy file opening was worth the hassle in Vim, but I found pressing <code>Space+f</code> to pick files and <code>Space+b</code> to switch between open buffers to be quite convenient in Helix.</p>
<p>LSP-powered code navigation was handy, particularly when tackling challenges where a certain amount of refactoring was called for.
Pressing <code>gd</code> (go to definition) takes you to the definition of a symbol; from there <code>Ctrl+o</code> (out) and <code>Ctrl+i</code> (in) act like back and forward in a web browser, but for code locations.
For this to work properly you need a <code>compile_commands.json</code> file; I use <a href="https://github.com/rizsotto/Bear"><strong>Bear</strong></a> for this whenever a source file is added or renamed:</p>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> make clean</span> <span class="z-keyword z-operator z-logical z-and z-shell">&amp;&amp;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">bear</span></span><span class="z-meta z-function-call z-arguments z-shell"> make all</span>
</span></code></pre>
<p>Helix doesn't have a visual block mode like Vim yet, but you can get a similar effect using its <em>multiple cursors</em> feature.
Pressing <code>C</code> creates an additional cursor on the next line, so you can line up the cursor at the first line of a block, press <code>C</code> a bunch of times and type on every line simultaneously;
this is pretty handy for dealing with test data and quickly commenting and uncommenting code blocks.</p>
<h2 id="compiling-and-linking-with-gnu-make"><a class="zola-anchor" href="#compiling-and-linking-with-gnu-make" aria-label="Anchor link for: compiling-and-linking-with-gnu-make">&num;</a>
Compiling and Linking with GNU Make</h2>
<p>The two biggest jobs of a Makefile for a C project are:</p>
<ol>
<li>Compile each C source file (ending with <code>.c</code>) into a corresponding object file (ending with <code>.o</code>).</li>
<li>Link the object files into executable binary files.</li>
</ol>
<p>There's a lot of information out there about how to write simple Makefiles that do these two things, but they have a lot of downsides:</p>
<ul>
<li>Object files are generated next to source files, which makes navigating the source code messy and complicates cleaning.</li>
<li>Compiling source files with different flags requires any previous build to be cleaned out first, e.g. for debug versus release builds.</li>
<li>The list of source files each object file depends on needs to be kept up-to-date when files change.</li>
<li>The list of object files each binary depends on needs to be kept up-to-date when files change.</li>
</ul>
<p>Tools like CMake and GNU Autotools can deal with or mitigate some of these issues, but they're also pretty complex.
The clox interpreter as described in <em>Crafting Interpreters</em> consists of twenty source files with no external dependencies, so I decided to tackle all of this with just GNU Make instead.
With a bit of elbow grease, I ended up with a Makefile that I didn't have to update, even when new files were introduced or <code>#include</code>s were changed.</p>
<p>The final Makefile: <a href="https://github.com/tung/clox/blob/master/Makefile">https://github.com/tung/clox/blob/master/Makefile</a></p>
<h3 id="out-of-tree-builds"><a class="zola-anchor" href="#out-of-tree-builds" aria-label="Anchor link for: out-of-tree-builds">&num;</a>
Out-of-Tree Builds</h3>
<p>The first issue with a simple C Makefile is that object files end up in the same directory as the source code.
Right away, I decided on the directory layout I wanted files to end up in:</p>
<ul>
<li><code>src/</code> for C source files <em>and</em> headers</li>
<li><code>build/</code> for build artifacts like object files and binaries</li>
</ul>
<p>I decided against having a separate <code>include/</code> directory.
Project-local headers are typically <code>#include</code>d with double quotes, which take file-relative paths and only fall back on searching include paths afterwards, so it's simpler to <code>#include</code> such files when they live in the same directory.
On top of this, a header named <code>foo.h</code> is most likely to change when its matching <code>foo.c</code> source file changes; keeping those files next to each other makes it easier to open one when changing the other.</p>
<p>The Makefile defines explicit variables for these directories:</p>
<pre data-lang="make" class="language-make z-code"><code class="language-make" data-lang="make"><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">src_dir</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile">src/</span></span>
</span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">header_dir</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>src_dir<span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span></span>
</span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">build_dir</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile">build/</span></span>
</span></code></pre>
<p>Having explicit variables like this is useful later on, so there's no mucking about with <code>VPATH</code> or anything like that.</p>
<p>If all I wanted was to split out build artifacts from source files, I could define Make rule targets directly in terms of <code>build_dir</code>.
But it doesn't end here, because I wanted...</p>
<h3 id="build-modes"><a class="zola-anchor" href="#build-modes" aria-label="Anchor link for: build-modes">&num;</a>
Build Modes</h3>
<p>I wanted to support compiling and linking clox in at least two different ways:</p>
<ol>
<li><em>Debug mode</em> with debugging information and extra runtime checks.</li>
<li><em>Release mode</em> with all optimizations applied.</li>
</ol>
<p>Therefore, each source file compiles into a least <em>two</em> separate object files, which are linked into <em>two</em> separate <code>clox</code> interpreter binaries.
In other words, I needed a <code>build/debug/</code> directory for debug build artifacts and a <code>build/release/</code> directory for release build artifacts.</p>
<p>The Makefile starts by taking a <code>MODE</code> variable<label for="note-1" class="margin-toggle sidenote-number"></label><input type="checkbox" id="note-1" class="margin-toggle"/><span class="sidenote"><a href="https://www.gnu.org/software/make/manual/make.html#toc-How-to-Use-Variables">By convention</a>, upper case names are used for variables that can be overriden.</span> that can be set to <code>debug</code> or <code>release</code>, defaulting to the former, and defining a <code>mode_dir</code> variable:</p>
<pre data-lang="make" class="language-make z-code"><code class="language-make" data-lang="make"><span class="z-source z-makefile"><span class="z-meta z-group z-makefile"><span class="z-keyword z-control z-conditional z-makefile">ifeq</span> <span class="z-punctuation z-section z-group z-begin z-makefile">(</span><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>MODE<span class="z-keyword z-other z-block z-end z-makefile">)</span></span><span class="z-punctuation z-separator z-makefile">,</span><span class="z-punctuation z-section z-group z-end z-makefile">)</span></span>
</span><span class="z-source z-makefile">  <span class="z-keyword z-control z-makefile">override</span><span class="z-variable z-other z-makefile"> MODE</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile">debug</span></span>
</span><span class="z-source z-makefile">  <span class="z-meta z-function-call z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span><span class="z-support z-function z-builtin z-makefile">info</span> </span><span class="z-meta z-function-call z-arguments z-makefile">Using default MODE = <span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>MODE<span class="z-keyword z-other z-block z-end z-makefile">)</span></span>.</span><span class="z-keyword z-other z-block z-end z-makefile">)</span>
</span><span class="z-source z-makefile"><span class="z-keyword z-control z-conditional z-makefile">endif</span>
</span><span class="z-source z-makefile">
</span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">mode_dir</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>build_dir<span class="z-keyword z-other z-block z-end z-makefile">)</span></span><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>MODE<span class="z-keyword z-other z-block z-end z-makefile">)</span></span>/</span></span>
</span></code></pre>
<p>The <code>mode_dir</code> is set to a subdirectory of <code>build_dir</code>, and it's where all of the files created by the build system will be placed.
Thus, all files created by the build are defined in terms of this <code>mode_dir</code>.</p>
<p>The <code>MODE</code> also determines the values of the <code>CFLAGS</code>, <code>LDFLAGS</code> and <code>LDLIBS</code> variables.<label for="note-2" class="margin-toggle sidenote-number"></label><input type="checkbox" id="note-2" class="margin-toggle"/><span class="sidenote">These variables are used by <a href="https://www.gnu.org/software/make/manual/make.html#Catalogue-of-Rules">GNU Make's implicit rules</a>, but otherwise there's nothing special about them.</span>
First, for debug mode:</p>
<pre data-lang="make" class="language-make z-code"><code class="language-make" data-lang="make"><span class="z-source z-makefile"><span class="z-meta z-group z-makefile"><span class="z-keyword z-control z-conditional z-makefile">ifeq</span> <span class="z-punctuation z-section z-group z-begin z-makefile">(</span><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>MODE<span class="z-keyword z-other z-block z-end z-makefile">)</span></span><span class="z-punctuation z-separator z-makefile">,</span>debug<span class="z-punctuation z-section z-group z-end z-makefile">)</span></span>
</span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">  CFLAGS</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile">-Wall -Wextra -Og -g -fsanitize=address -fsanitize=undefined -fno-omit-frame-pointer</span></span>
</span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">  LDFLAGS</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile">-Og -g -fsanitize=address -fsanitize=undefined</span></span>
</span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">  LDLIBS</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile">-lm</span></span>
</span></code></pre>
<p>The <code>LDLIBS = -lm</code> is needed for some C standard library math functions I eventually ended up needing, but the interesting part is the other two lines.
A break-down of the flags I chose for debug mode:</p>
<ul>
<li><code>-Wall -Wextra</code> - Turns on lots of warnings to ward off problems before they become bugs.
Some people add <code>-Werror</code> to this mix, but I chase down all warnings on sight, so I didn't need it.</li>
<li><code>-Og -g</code> - Include debugging information; <code>-g</code> adds the info, and <code>-Og</code> runs "optimization" passes that gather extra debugging info.</li>
<li><code>-fsanitize=address</code> - Turns on <a href="https://clang.llvm.org/docs/AddressSanitizer.html"><strong>AddressSanitizer</strong></a> to detect memory errors;
this is <em>extremely</em> helpful when working on the <a href="https://craftinginterpreters.com/garbage-collection.html">garbage collection chapter</a>.
Any memory errors will produce stack traces where the memory error occurred, where it was freed and and where it was allocated.
This flag automatically enables <code>-fsanitize=leak</code> for <a href="https://clang.llvm.org/docs/LeakSanitizer.html"><strong>LeakSanitizer</strong></a> on Linux, which catches unfreed memory on exit.</li>
<li><code>-fno-omit-frame-pointer</code> - Keeps frame pointers for better stack traces.</li>
</ul>
<p>AddressSanitizer works very nicely when running the garbage collector in stress mode (i.e. collecting before every single memory allocation);
doing so will catch and precisely identify memory allocations you have in the stack but forgot to keep rooted.</p>
<p>Here's release mode:</p>
<pre data-lang="make" class="language-make z-code"><code class="language-make" data-lang="make"><span class="z-source z-makefile"><span class="z-keyword z-control z-conditional z-makefile">else</span> <span class="z-meta z-group z-makefile"><span class="z-keyword z-control z-conditional z-makefile">ifeq</span> <span class="z-punctuation z-section z-group z-begin z-makefile">(</span><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>MODE<span class="z-keyword z-other z-block z-end z-makefile">)</span></span><span class="z-punctuation z-separator z-makefile">,</span>release<span class="z-punctuation z-section z-group z-end z-makefile">)</span></span>
</span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">  CFLAGS</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile">-Wall -Wextra -O3 -flto -march=native</span></span>
</span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">  LDFLAGS</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile">-O3 -flto -march=native</span></span>
</span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">  LDLIBS</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile">-lm</span></span>
</span></code></pre>
<p>Release flags break-down:</p>
<ul>
<li><code>-O3</code> - Optimize for performance.</li>
<li><code>-flto</code> - Link-time optimization.
The way it works is by first compiling each source file into an compiler-internal representation.
When everything is linked, optimizations are applied as if everything had been part of the same source file.</li>
<li><code>-march=native</code> - Allows the use of features of the CPU currently being used to build the project.
It reduces portability, but boosts performance a bit.</li>
</ul>
<h3 id="automatic-dependencies-for-compiling-c-files"><a class="zola-anchor" href="#automatic-dependencies-for-compiling-c-files" aria-label="Anchor link for: automatic-dependencies-for-compiling-c-files">&num;</a>
Automatic Dependencies for Compiling C Files</h3>
<p>GCC's C preprocessor can output the list of source and header files that an object file depends on.
For example, I can get the dependencies of <code>scanner.o</code> by processing <code>scanner.c</code> like so:</p>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> cc<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>E</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>MM</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>MT</span> build/debug/objs/scanner.o scanner.c</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">build/debug/objs/scanner.o:</span></span><span class="z-meta z-function-call z-arguments z-shell"> src/scanner.c src/scanner.h src/common.h</span>
</span></code></pre>
<p><code>cc -E</code> runs the C preprocessor, <code>-MM</code> emits the Make-compatible rule with dependency info (no system headers) and <code>-MT foo</code> sets the rule target, i.e. the part before the <code>:</code> (colon) character in the output.</p>
<p>GNU Make can then include this Makefile fragment<label for="note-3" class="margin-toggle sidenote-number"></label><input type="checkbox" id="note-3" class="margin-toggle"/><span class="sidenote">I call these "Makefile fragments"; I don't know if they have an official name.</span> and roll it into its internal dependency graph, so object files are only rebuilt when the <em>exact</em> files they depend on are changed.</p>
<p>The cut-down setup put together looks like this:</p>
<pre data-lang="make" class="language-make z-code"><code class="language-make" data-lang="make"><span class="z-source z-makefile"><span class="z-comment z-line z-number-sign z-makefile"><span class="z-punctuation z-definition z-comment z-makefile">#</span> From before.
</span></span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">src_dir</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile">...</span></span>
</span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">build_dir</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile">...</span></span>
</span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">mode_dir</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile">...</span></span>
</span><span class="z-source z-makefile">
</span><span class="z-source z-makefile"><span class="z-comment z-line z-number-sign z-makefile"><span class="z-punctuation z-definition z-comment z-makefile">#</span> e.g. build/debug/deps/
</span></span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">deps_dir</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>mode_dir<span class="z-keyword z-other z-block z-end z-makefile">)</span></span>deps/</span></span>
</span><span class="z-source z-makefile">
</span><span class="z-source z-makefile"><span class="z-comment z-line z-number-sign z-makefile"><span class="z-punctuation z-definition z-comment z-makefile">#</span> e.g. build/debug/objs/
</span></span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">objs_dir</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>mode_dir<span class="z-keyword z-other z-block z-end z-makefile">)</span></span>objs/</span></span>
</span><span class="z-source z-makefile">
</span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">c_srcs</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile"><span class="z-meta z-function-call z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span><span class="z-support z-function z-builtin z-makefile">wildcard</span> </span><span class="z-meta z-function-call z-arguments z-makefile"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>src_dir<span class="z-keyword z-other z-block z-end z-makefile">)</span></span><span class="z-variable z-language z-wildcard z-makefile">*</span>.c</span><span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span>
</span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">c_deps</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>c_srcs<span class="z-punctuation z-definition z-substitution z-makefile">:</span><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>src_dir<span class="z-keyword z-other z-block z-end z-makefile">)</span></span><span class="z-variable z-language z-makefile">%</span>.c<span class="z-punctuation z-definition z-assignment z-makefile">=</span><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>deps_dir<span class="z-keyword z-other z-block z-end z-makefile">)</span></span><span class="z-variable z-language z-makefile">%</span>.d<span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span></span>
</span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">c_objs</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>c_srcs<span class="z-punctuation z-definition z-substitution z-makefile">:</span><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>src_dir<span class="z-keyword z-other z-block z-end z-makefile">)</span></span><span class="z-variable z-language z-makefile">%</span>.c<span class="z-punctuation z-definition z-assignment z-makefile">=</span><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>objs_dir<span class="z-keyword z-other z-block z-end z-makefile">)</span></span><span class="z-variable z-language z-makefile">%</span>.o<span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span></span>
</span><span class="z-source z-makefile">
</span><span class="z-source z-makefile"><span class="z-comment z-line z-number-sign z-makefile"><span class="z-punctuation z-definition z-comment z-makefile">#</span> Generate *.d files from *.c files.
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-makefile"><span class="z-entity z-name z-function z-makefile"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>c_deps<span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span></span><span class="z-keyword z-operator z-assignment z-makefile">:</span> <span class="z-meta z-function z-arguments z-makefile"><span class="z-string z-unquoted z-makefile"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>deps_dir<span class="z-keyword z-other z-block z-end z-makefile">)</span></span><span class="z-variable z-language z-makefile">%</span>.d: <span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>src_dir<span class="z-keyword z-other z-block z-end z-makefile">)</span></span><span class="z-variable z-language z-makefile">%</span>.c</span></span><span class="z-meta z-function z-body z-makefile">
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile"></span><span class="z-meta z-function z-body z-makefile">	<span class="z-source z-shell"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>CPP<span class="z-keyword z-other z-block z-end z-makefile">)</span></span> <span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>CPPFLAGS<span class="z-keyword z-other z-block z-end z-makefile">)</span></span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-MM</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>MT</span> <span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>@<span class="z-punctuation z-definition z-substitution z-makefile">:</span><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>deps_dir<span class="z-keyword z-other z-block z-end z-makefile">)</span></span><span class="z-variable z-language z-makefile">%</span>.d<span class="z-punctuation z-definition z-assignment z-makefile">=</span><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>objs_dir<span class="z-keyword z-other z-block z-end z-makefile">)</span></span><span class="z-variable z-language z-makefile">%</span>.o<span class="z-keyword z-other z-block z-end z-makefile">)</span></span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>MT</span> <span class="z-variable z-language z-automatic z-makefile">$@</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>MP</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>MF</span> <span class="z-variable z-language z-automatic z-makefile">$@</span> <span class="z-variable z-language z-automatic z-makefile">$&lt;</span></span></span>
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile">
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile"></span><span class="z-comment z-line z-number-sign z-makefile"><span class="z-punctuation z-definition z-comment z-makefile">#</span> Read in *.d files; generate them if they don&#39;t exist yet.
</span></span><span class="z-source z-makefile"><span class="z-keyword z-control z-import z-makefile">-include</span> <span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>c_deps<span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span></span>
</span><span class="z-source z-makefile">
</span><span class="z-source z-makefile"><span class="z-comment z-line z-number-sign z-makefile"><span class="z-punctuation z-definition z-comment z-makefile">#</span> Generate *.o files from *.c files.
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-makefile"><span class="z-entity z-name z-function z-makefile"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>c_objs<span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span></span><span class="z-keyword z-operator z-assignment z-makefile">:</span> <span class="z-meta z-function z-arguments z-makefile"><span class="z-string z-unquoted z-makefile"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>objs_dir<span class="z-keyword z-other z-block z-end z-makefile">)</span></span><span class="z-variable z-language z-makefile">%</span>.o: <span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>src_dir<span class="z-keyword z-other z-block z-end z-makefile">)</span></span><span class="z-variable z-language z-makefile">%</span>.c</span></span><span class="z-meta z-function z-body z-makefile">
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile"></span><span class="z-meta z-function z-body z-makefile">	<span class="z-source z-shell"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>CC<span class="z-keyword z-other z-block z-end z-makefile">)</span></span> <span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>CPPFLAGS<span class="z-keyword z-other z-block z-end z-makefile">)</span></span> <span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>CFLAGS<span class="z-keyword z-other z-block z-end z-makefile">)</span></span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-c</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>o</span> <span class="z-variable z-language z-automatic z-makefile">$@</span> <span class="z-variable z-language z-automatic z-makefile">$&lt;</span></span></span>
</span></span></code></pre>
<p>There's some Makefile voodoo going on up there, which I'll try to explain.</p>
<p><code>$(wildcard src/*.c)</code> is a bit like running <code>ls src/*.c</code>, so <code>c_srcs = $(wildcard $(src_dir)*.c)</code> sets the <code>c_srcs</code> variable to something like <code>src/foo.c src/bar.c src/baz.c</code>.</p>
<p><code>$(c_srcs:$(src_dir)%.c=$(deps_dir)%.c)</code> is a <a href="https://www.gnu.org/software/make/manual/make.html#Substitution-Refs">substitution reference</a> that expands to something like <code>$(c_srcs:src/%.c=build/debug/deps/%.d)</code>, which matches each file in <code>c_srcs</code> against the pattern <code>src/%.c</code> and replaces the non-<code>%</code> parts with the pattern <code>build/debug/deps/%.d</code>.
For example, going with <code>c_srcs</code> from before, this would come out to <code>build/debug/deps/foo.d build/debug/deps/bar.d build/debug/deps/baz.d</code>.</p>
<p>The <code>$(c_deps): $(deps_dir)%.d: $(src_dir)%.c</code> is the first line of a <a href="https://www.gnu.org/software/make/manual/make.html#Static-Pattern">static pattern rule</a>.
If it were typed manually, it'd expand to this:</p>
<pre data-lang="make" class="language-make z-code"><code class="language-make" data-lang="make"><span class="z-source z-makefile"><span class="z-meta z-function z-makefile"><span class="z-entity z-name z-function z-makefile">build/debug/deps/foo.d</span></span><span class="z-keyword z-operator z-assignment z-makefile">:</span> <span class="z-meta z-function z-arguments z-makefile"><span class="z-string z-unquoted z-makefile">src/foo.c</span></span><span class="z-meta z-function z-body z-makefile">
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile"></span><span class="z-meta z-function z-body z-makefile">	<span class="z-source z-shell"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">...</span></span></span>
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile">
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile"></span><span class="z-meta z-function z-makefile"><span class="z-entity z-name z-function z-makefile">build/debug/deps/bar.d</span></span><span class="z-keyword z-operator z-assignment z-makefile">:</span> <span class="z-meta z-function z-arguments z-makefile"><span class="z-string z-unquoted z-makefile">src/bar.c</span></span><span class="z-meta z-function z-body z-makefile">
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile"></span><span class="z-meta z-function z-body z-makefile">	<span class="z-source z-shell"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">...</span></span></span>
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile">
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile"></span><span class="z-meta z-function z-makefile"><span class="z-entity z-name z-function z-makefile">build/debug/deps/baz.d</span></span><span class="z-keyword z-operator z-assignment z-makefile">:</span> <span class="z-meta z-function z-arguments z-makefile"><span class="z-string z-unquoted z-makefile">src/baz.c</span></span><span class="z-meta z-function z-body z-makefile">
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile"></span><span class="z-meta z-function z-body z-makefile">	<span class="z-source z-shell"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">...</span></span></span>
</span></span></code></pre>
<p>The tab-indented lines are the <em>recipe</em> of the rule.
The <code>$@</code> and <code>$&lt;</code> are references to the <a href="https://www.gnu.org/software/make/manual/make.html#Automatic-Variables">automatic variables</a> <code>@</code> and <code>&lt;</code>;
<code>@</code> is a stand-in for the rule <em>target</em> (the thing to the left of the <code>:</code> character), while <code>&lt;</code> is the first prerequisite (the first thing to the right of the <code>:</code> character).
For example, we can expand the rule to make the target <code>build/debug/deps/foo.d</code> like so:</p>
<pre data-lang="make" class="language-make z-code"><code class="language-make" data-lang="make"><span class="z-source z-makefile"><span class="z-meta z-function z-makefile"><span class="z-entity z-name z-function z-makefile">build/debug/deps/foo.d</span></span><span class="z-keyword z-operator z-assignment z-makefile">:</span> <span class="z-meta z-function z-arguments z-makefile"><span class="z-string z-unquoted z-makefile">src/foo.c</span></span><span class="z-meta z-function z-body z-makefile">
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile"></span><span class="z-meta z-function z-body z-makefile">	<span class="z-source z-shell"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>CPP<span class="z-keyword z-other z-block z-end z-makefile">)</span></span> <span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>CPPFLAGS<span class="z-keyword z-other z-block z-end z-makefile">)</span></span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-MM</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>MT</span> build/debug/objs/foo.o<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>MT</span> build/debug/deps/foo.d<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>MP</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>MF</span> build/debug/deps/foo.d src/foo.c</span></span>
</span></span></code></pre>
<p><code>-MT</code> can be specified multiple times to put multiple things to the left of the <code>:</code> character when the C preprocessor works its magic;
the <code>foo.d</code> Makefile fragment is included so the dependency will rebuild itself along with the object file if any of the discovered dependencies change.
Meanwhile, <code>-MP</code> creates phony rules to deal with errors that Make complains about when files are deleted and <code>-MF foo.d</code> writes the Makefile fragment to the file named <code>foo.d</code>.</p>
<p>The <code>-include $(c_deps)</code> line is where all the magic happens.
The <code>include</code> keyword causes GNU Make to <a href="https://www.gnu.org/software/make/manual/make.html#Include">include our Makefile fragments</a>;
using <code>-include</code> (with the leading dash) instead ignores warnings about missing files.
If GNU Make realizes these files are missing, it'll finish reading the Makefile and run the rules needed to create them before restarting and running itself again.<label for="note-4" class="margin-toggle sidenote-number"></label><input type="checkbox" id="note-4" class="margin-toggle"/><span class="sidenote">There's a <a href="https://www.gnu.org/software/make/manual/make.html#Remaking-Makefiles">limit</a> to the number of times GNU Make will restart itself, so there's no need to worry about infinite loops.</span></p>
<p>The rules to build the object files from the C source files are typical fare for Makefiles.
This takes advantage of the fact that a target can have multiple rules that can build up the dependency list, as long as only one of them has recipe.</p>
<h3 id="automatic-dependencies-for-linking-c-programs"><a class="zola-anchor" href="#automatic-dependencies-for-linking-c-programs" aria-label="Anchor link for: automatic-dependencies-for-linking-c-programs">&num;</a>
Automatic Dependencies for Linking C Programs</h3>
<p>If I was only going to link all the object files into a single binary, a simple rule like this would be enough (where <code>^</code> is the dependency list for the rule):</p>
<pre data-lang="make" class="language-make z-code"><code class="language-make" data-lang="make"><span class="z-source z-makefile"><span class="z-comment z-line z-number-sign z-makefile"><span class="z-punctuation z-definition z-comment z-makefile">#</span> From before.
</span></span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">c_objs</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile">...</span></span>
</span><span class="z-source z-makefile">
</span><span class="z-source z-makefile"><span class="z-meta z-function z-makefile"><span class="z-entity z-name z-function z-makefile">clox</span></span><span class="z-keyword z-operator z-assignment z-makefile">:</span> <span class="z-meta z-function z-arguments z-makefile"><span class="z-string z-unquoted z-makefile"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>c_objs<span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span></span><span class="z-meta z-function z-body z-makefile">
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile"></span><span class="z-meta z-function z-body z-makefile">	<span class="z-source z-shell"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>CC<span class="z-keyword z-other z-block z-end z-makefile">)</span></span> <span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>LDFLAGS<span class="z-keyword z-other z-block z-end z-makefile">)</span></span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-o</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-variable z-language z-automatic z-makefile">$@</span> <span class="z-variable z-language z-automatic z-makefile">$^</span> <span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>LDLIBS<span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span></span>
</span></span></code></pre>
<p>However, I knew I would have additional binaries for things like tests and benchmarks, and each of those would need their own lists of object files.
Managing object dependencies for linking test and benchmark binaries would be tedious and discourage me from adding new ones when I needed to, so I wondered if there was a way to work them out automatically.
As it turns out, there is, but it takes some creative thinking.</p>
<p>The goal here is to discover the object files (ending with <code>.o</code>) needed to link a binary, and do so automatically.
I needed to do what the C preprocessor was doing for object files reading source and header files, but do it for binaries with object files.</p>
<p>The key is in the Makefile fragments from before (ending with <code>.d</code>): if you squint, you can see that it describes the entire dependency graph!
Specifically, if a Makefile fragment mentions a <code>.o</code> file, it needs to be linked in, and if it mentions a <code>.h</code> file, it probably has a matching <code>.c</code> file and therefore a <code>.d</code> file that we should also read.
The approach looks roughly like this:</p>
<ol>
<li>Initialize a <code>.d</code> list with the <code>.d</code> file for the <code>.c</code> source file containing the <code>main</code> function.</li>
<li>While the <code>.d</code> list has more entries:
<ul>
<li>If the current <code>.d</code> file doesn't exist, skip to the next in the <code>.d</code> list.</li>
<li>Read space-separated words from the current <code>.d</code> file.</li>
<li>If the word ends with <code>.o</code>, add it to the list of objects to link into the binary if it's not already there.</li>
<li>If the word ends with <code>.h</code>, convert it to into a <code>.d</code> file path and add it to the <code>.d</code> list if it's not already there.</li>
</ul>
</li>
<li>Output a Makefile-compatible rule with the binary name as the target and the list of objects as dependencies.</li>
</ol>
<p>Here's the Bash script I wrote that does this: <a href="https://github.com/tung/clox/blob/master/linkrule.bash">https://github.com/tung/clox/blob/master/linkrule.bash</a></p>
<p>The rule to create automatic link dependencies for the main clox interpreter binary looks like this:</p>
<pre data-lang="make" class="language-make z-code"><code class="language-make" data-lang="make"><span class="z-source z-makefile"><span class="z-comment z-line z-number-sign z-makefile"><span class="z-punctuation z-definition z-comment z-makefile">#</span> From before.
</span></span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">src_dir</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile">...</span></span>
</span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">header_dir</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile">...</span></span>
</span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">deps_dir</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile">...</span></span>
</span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">mode_dir</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile">...</span></span>
</span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">c_deps</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile">...</span></span>
</span><span class="z-source z-makefile">
</span><span class="z-source z-makefile"><span class="z-comment z-line z-number-sign z-makefile"><span class="z-punctuation z-definition z-comment z-makefile">#</span> Directory of this Makefile; not fully reliable, but good enough for our purposes.
</span></span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">makefile_prefix</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile"><span class="z-meta z-function-call z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span><span class="z-support z-function z-builtin z-makefile">dir</span> </span><span class="z-meta z-function-call z-arguments z-makefile"><span class="z-meta z-function-call z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span><span class="z-support z-function z-builtin z-makefile">firstword</span> </span><span class="z-meta z-function-call z-arguments z-makefile"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>MAKEFILE_LIST<span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span><span class="z-keyword z-other z-block z-end z-makefile">)</span></span><span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span>
</span><span class="z-source z-makefile">
</span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">main_name</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile">clox</span></span>
</span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">main_src</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>src_dir<span class="z-keyword z-other z-block z-end z-makefile">)</span></span>main.c</span></span>
</span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">main_target</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>mode_dir<span class="z-keyword z-other z-block z-end z-makefile">)</span></span><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>main_name<span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span></span>
</span><span class="z-source z-makefile">
</span><span class="z-source z-makefile"><span class="z-comment z-line z-number-sign z-makefile"><span class="z-punctuation z-definition z-comment z-makefile">#</span> e.g. build/debug/deps/main.link.d
</span></span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">main_link_dep</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>main_src<span class="z-punctuation z-definition z-substitution z-makefile">:</span><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>src_dir<span class="z-keyword z-other z-block z-end z-makefile">)</span></span><span class="z-variable z-language z-makefile">%</span>.c<span class="z-punctuation z-definition z-assignment z-makefile">=</span><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>deps_dir<span class="z-keyword z-other z-block z-end z-makefile">)</span></span><span class="z-variable z-language z-makefile">%</span>.link.d<span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span></span>
</span><span class="z-source z-makefile">
</span><span class="z-source z-makefile"><span class="z-comment z-line z-number-sign z-makefile"><span class="z-punctuation z-definition z-comment z-makefile">#</span> Generate *.link.d files from *.d files.
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-makefile"><span class="z-entity z-name z-function z-makefile"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>main_link_dep<span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span></span><span class="z-keyword z-operator z-assignment z-makefile">:</span> <span class="z-meta z-function z-arguments z-makefile"><span class="z-string z-unquoted z-makefile">| <span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>c_deps<span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span></span><span class="z-meta z-function z-body z-makefile">
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile"></span><span class="z-meta z-function z-body z-makefile">	<span class="z-source z-shell"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>makefile_prefix<span class="z-keyword z-other z-block z-end z-makefile">)</span></span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">linkrule.bash</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-variable z-language z-automatic z-makefile">$@</span> <span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>main_target<span class="z-keyword z-other z-block z-end z-makefile">)</span></span> <span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>@<span class="z-punctuation z-definition z-substitution z-makefile">:</span>.link.d<span class="z-punctuation z-definition z-assignment z-makefile">=</span>.d<span class="z-keyword z-other z-block z-end z-makefile">)</span></span> <span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>header_dir<span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span></span>
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile">
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile"></span><span class="z-comment z-line z-number-sign z-makefile"><span class="z-punctuation z-definition z-comment z-makefile">#</span> Read in e.g. build/debug/deps/main.link.d; generate it if it doesn&#39;t exist yet.
</span></span><span class="z-source z-makefile"><span class="z-keyword z-control z-import z-makefile">-include</span> <span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>main_link_dep<span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span></span>
</span><span class="z-source z-makefile">
</span><span class="z-source z-makefile"><span class="z-comment z-line z-number-sign z-makefile"><span class="z-punctuation z-definition z-comment z-makefile">#</span> Link the main target binary, e.g. build/debug/clox
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-makefile"><span class="z-entity z-name z-function z-makefile"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>main_target<span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span></span><span class="z-keyword z-operator z-assignment z-makefile">:</span>
<span class="z-meta z-function z-arguments z-makefile"></span><span class="z-meta z-function z-body z-makefile"></span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile"></span><span class="z-meta z-function z-body z-makefile">	<span class="z-source z-shell"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>CC<span class="z-keyword z-other z-block z-end z-makefile">)</span></span> <span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>LDFLAGS<span class="z-keyword z-other z-block z-end z-makefile">)</span></span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-o</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-variable z-language z-automatic z-makefile">$@</span> <span class="z-variable z-language z-automatic z-makefile">$^</span> <span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>LDLIBS<span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span></span>
</span></span></code></pre>
<p>The <code>$(main_link_dep): | $(c_deps)</code> line is new;
the <code>|</code> (pipe) character denote <a href="https://www.gnu.org/software/make/manual/make.html#Prerequisite-Types">order-only prerequisites</a> that are only checked for existence, not timestamp like normal prerequisites.
If the <code>.d</code> files don't exist yet, I want all of them to be created before reading anything.
After that, the <code>linkrule.bash</code> script contains more fine-grained dependency information for specific <code>.d</code> files.</p>
<p>The <code>$(@:.link.d=.d)</code> substitution reference matches the <code>.link.d</code> suffix and replaces it with just a <code>.d</code> suffix.</p>
<p>If <code>clox</code> was the only binary, this would be a huge waste of time.
Doing this for test binaries is a lot more useful:</p>
<pre data-lang="make" class="language-make z-code"><code class="language-make" data-lang="make"><span class="z-source z-makefile"><span class="z-comment z-line z-number-sign z-makefile"><span class="z-punctuation z-definition z-comment z-makefile">#</span> From before.
</span></span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">src_dir</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile">...</span></span>
</span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">header_dir</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile">...</span></span>
</span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">deps_dir</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile">...</span></span>
</span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">mode_dir</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile">...</span></span>
</span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">c_deps</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile">...</span></span>
</span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">makefile_prefix</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile">...</span></span>
</span><span class="z-source z-makefile">
</span><span class="z-source z-makefile"><span class="z-comment z-line z-number-sign z-makefile"><span class="z-punctuation z-definition z-comment z-makefile">#</span> e.g. src/foo_test.c src/bar_test.c
</span></span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">test_srcs</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile"><span class="z-meta z-function-call z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span><span class="z-support z-function z-builtin z-makefile">wildcard</span> </span><span class="z-meta z-function-call z-arguments z-makefile"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>src_dir<span class="z-keyword z-other z-block z-end z-makefile">)</span></span><span class="z-variable z-language z-wildcard z-makefile">*</span>_test.c</span><span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span>
</span><span class="z-source z-makefile">
</span><span class="z-source z-makefile"><span class="z-comment z-line z-number-sign z-makefile"><span class="z-punctuation z-definition z-comment z-makefile">#</span> e.g. build/debug/foo_test build/debug/bar_test
</span></span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">tests</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>test_srcs<span class="z-punctuation z-definition z-substitution z-makefile">:</span><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>src_dir<span class="z-keyword z-other z-block z-end z-makefile">)</span></span><span class="z-variable z-language z-makefile">%</span>.c<span class="z-punctuation z-definition z-assignment z-makefile">=</span><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>mode_dir<span class="z-keyword z-other z-block z-end z-makefile">)</span></span><span class="z-variable z-language z-makefile">%</span><span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span></span>
</span><span class="z-source z-makefile">
</span><span class="z-source z-makefile"><span class="z-comment z-line z-number-sign z-makefile"><span class="z-punctuation z-definition z-comment z-makefile">#</span> e.g. build/debug/deps/foo_test.link.d build/debug/deps/bar_test.link.d
</span></span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">test_link_deps</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>test_srcs<span class="z-punctuation z-definition z-substitution z-makefile">:</span><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>src_dir<span class="z-keyword z-other z-block z-end z-makefile">)</span></span><span class="z-variable z-language z-makefile">%</span>.c<span class="z-punctuation z-definition z-assignment z-makefile">=</span><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>deps_dir<span class="z-keyword z-other z-block z-end z-makefile">)</span></span><span class="z-variable z-language z-makefile">%</span>.link.d<span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span></span>
</span><span class="z-source z-makefile">
</span><span class="z-source z-makefile"><span class="z-comment z-line z-number-sign z-makefile"><span class="z-punctuation z-definition z-comment z-makefile">#</span> Generate *.link.d files from *.d files for tests.
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-makefile"><span class="z-entity z-name z-function z-makefile"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>test_link_deps<span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span></span><span class="z-keyword z-operator z-assignment z-makefile">:</span> <span class="z-meta z-function z-arguments z-makefile"><span class="z-string z-unquoted z-makefile"><span class="z-variable z-language z-makefile">%</span>.link.d: | <span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>c_deps<span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span></span><span class="z-meta z-function z-body z-makefile">
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile"></span><span class="z-meta z-function z-body z-makefile">	<span class="z-source z-shell"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>makefile_prefix<span class="z-keyword z-other z-block z-end z-makefile">)</span></span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">linkrule.bash</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-variable z-language z-automatic z-makefile">$@</span> <span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>*<span class="z-punctuation z-definition z-substitution z-makefile">:</span><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>deps_dir<span class="z-keyword z-other z-block z-end z-makefile">)</span></span><span class="z-variable z-language z-makefile">%</span><span class="z-punctuation z-definition z-assignment z-makefile">=</span><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>mode_dir<span class="z-keyword z-other z-block z-end z-makefile">)</span></span><span class="z-variable z-language z-makefile">%</span><span class="z-keyword z-other z-block z-end z-makefile">)</span></span> <span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>@<span class="z-punctuation z-definition z-substitution z-makefile">:</span>.link.d<span class="z-punctuation z-definition z-assignment z-makefile">=</span>.d<span class="z-keyword z-other z-block z-end z-makefile">)</span></span> <span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>header_dir<span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span></span>
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile">
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile"></span><span class="z-comment z-line z-number-sign z-makefile"><span class="z-punctuation z-definition z-comment z-makefile">#</span> Link the test binaries, e.g. build/debug/foo_test and build/debug/bar_test.
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-makefile"><span class="z-entity z-name z-function z-makefile"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>tests<span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span></span><span class="z-keyword z-operator z-assignment z-makefile">:</span> <span class="z-meta z-function z-arguments z-makefile"><span class="z-string z-unquoted z-makefile"><span class="z-variable z-language z-makefile">%</span>:</span></span><span class="z-meta z-function z-body z-makefile">
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile"></span><span class="z-meta z-function z-body z-makefile">	<span class="z-source z-shell"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>CC<span class="z-keyword z-other z-block z-end z-makefile">)</span></span> <span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>LDFLAGS<span class="z-keyword z-other z-block z-end z-makefile">)</span></span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-o</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-variable z-language z-automatic z-makefile">$@</span> <span class="z-variable z-language z-automatic z-makefile">$^</span> <span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>LDLIBS<span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span></span>
</span></span></code></pre>
<p>The <code>*</code> (asterisk) automatic variable above refers to the part of the static pattern rule that the <code>%</code> matches, e.g. the following echoes <code>build/debug/deps/foo_test</code>:</p>
<pre data-lang="make" class="language-make z-code"><code class="language-make" data-lang="make"><span class="z-source z-makefile"><span class="z-meta z-function z-makefile"><span class="z-entity z-name z-function z-makefile">build/debug/deps/foo_test.link.d</span></span><span class="z-keyword z-operator z-assignment z-makefile">:</span> <span class="z-meta z-function z-arguments z-makefile"><span class="z-string z-unquoted z-makefile"><span class="z-variable z-language z-makefile">%</span>.link.d: | <span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>c_deps<span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span></span><span class="z-meta z-function z-body z-makefile">
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile"></span><span class="z-meta z-function z-body z-makefile">	<span class="z-source z-shell"><span class="z-meta z-function-call z-shell"><span class="z-support z-function z-echo z-shell">echo</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-variable z-language z-automatic z-makefile">$*</span></span></span>
</span></span></code></pre>
<p>The <code>$(*:$(deps_dir)%=$(mode_dir)%)</code> therefore turns <code>build/debug/deps/foo_test.link.d</code> into something like <code>build/debug/foo_test</code>, which is the output file path I want for the test binary.</p>
<p>When this was all put together, it closed the Makefile maintenance loop: I never had to revisit the Makefile when adding or moving files around at all!
Having this setup made working with C feel a bit more like working with a modern language.</p>
<h3 id="bonus-including-git-version-information"><a class="zola-anchor" href="#bonus-including-git-version-information" aria-label="Anchor link for: bonus-including-git-version-information">&num;</a>
Bonus: Including Git Version Information</h3>
<p>I thought it'd be nice for the clox binary to print out its version on request, like this (where <code>dedbeef</code> would be the short Git revision hash):</p>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> ./build/debug/clox<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>version</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">clox</span></span><span class="z-meta z-function-call z-arguments z-shell"> debug-git-dedbeef</span>
</span></code></pre>
<p>I decided to have the Makefile generate this information as a Makefile fragment and rebuild <code>src/main.c</code> to include it.</p>
<p>The idea is to have the Makefile run <code>git describe --always --dirty</code> and compare it to a Makefile fragment with the output of the same command from the previous run.
If the output and the fragment disagree, delete the fragment so it's considered out-of-date and recreated.
Object files created from <code>src/main.c</code> are set to depend on that fragment file, so they'll also be rebuilt.
Finally, the Makefile fragment is <code>-include</code>d and the <code>CFLAGS</code> is extended with that version string, but only for those object files.
Here it is, in stripped-down form:</p>
<pre data-lang="make" class="language-make z-code"><code class="language-make" data-lang="make"><span class="z-source z-makefile"><span class="z-comment z-line z-number-sign z-makefile"><span class="z-punctuation z-definition z-comment z-makefile">#</span> From before.
</span></span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">MODE</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile">...</span></span>
</span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">src_dir</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile">...</span></span>
</span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">mode_dir</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile">...</span></span>
</span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">objs_dir</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile">...</span></span>
</span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">c_objs</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile">...</span></span>
</span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">main_obj</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile">...</span></span>
</span><span class="z-source z-makefile">
</span><span class="z-source z-makefile"><span class="z-comment z-line z-number-sign z-makefile"><span class="z-punctuation z-definition z-comment z-makefile">#</span> e.g. build/debug/version.mk
</span></span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">version_mk</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>mode_dir<span class="z-keyword z-other z-block z-end z-makefile">)</span></span>version.mk</span></span>
</span><span class="z-source z-makefile">
</span><span class="z-source z-makefile"><span class="z-comment z-line z-number-sign z-makefile"><span class="z-punctuation z-definition z-comment z-makefile">#</span> Produce a version string for the current git repo state, e.g. debug-git-dedbeef
</span></span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">version</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>MODE<span class="z-keyword z-other z-block z-end z-makefile">)</span></span><span class="z-keyword z-other z-block z-begin z-makefile">$(</span><span class="z-support z-function z-builtin z-makefile">shell</span> <span class="z-source z-shell"><span class="z-variable z-other z-readwrite z-assignment z-shell">V</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$$(</span>git -C <span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>src_dir<span class="z-keyword z-other z-block z-end z-makefile">)</span></span> describe --always --dirty 2&gt;/dev/null<span class="z-keyword z-other z-block z-end z-makefile">)</span></span> <span class="z-meta z-function-call z-shell"></span><span class="z-keyword z-operator z-logical z-and z-shell">&amp;&amp;</span> <span class="z-meta z-function-call z-shell"><span class="z-support z-function z-printf z-shell">printf</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-keyword z-operator z-end-of-options z-shell"> --</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-string z-makefile"><span class="z-string z-quoted z-double z-makefile"><span class="z-punctuation z-definition z-string z-begin z-makefile">&quot;</span>-git-%s<span class="z-punctuation z-definition z-string z-end z-makefile">&quot;</span></span></span> <span class="z-meta z-string z-makefile"><span class="z-string z-quoted z-double z-makefile"><span class="z-punctuation z-definition z-string z-begin z-makefile">&quot;</span><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$${</span>V<span class="z-keyword z-other z-block z-end z-makefile">}</span></span><span class="z-punctuation z-definition z-string z-end z-makefile">&quot;</span></span></span> </span><span class="z-keyword z-operator z-logical z-or z-shell">||</span> <span class="z-meta z-function-call z-shell"><span class="z-support z-function z-printf z-shell">printf</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-string z-makefile"><span class="z-string z-quoted z-double z-makefile"><span class="z-punctuation z-definition z-string z-begin z-makefile">&quot;</span><span class="z-punctuation z-definition z-string z-end z-makefile">&quot;</span></span></span></span></span><span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span>
</span><span class="z-source z-makefile">
</span><span class="z-source z-makefile"><span class="z-comment z-line z-number-sign z-makefile"><span class="z-punctuation z-definition z-comment z-makefile">#</span> e.g. &quot;version_str = debug-git-dedbeef&quot;
</span></span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">version_fragment</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile">version_str = <span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>version<span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span></span>
</span><span class="z-source z-makefile">
</span><span class="z-source z-makefile"><span class="z-comment z-line z-number-sign z-makefile"><span class="z-punctuation z-definition z-comment z-makefile">#</span> Create the version Makefile fragment.
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-makefile"><span class="z-entity z-name z-function z-makefile"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>version_mk<span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span></span><span class="z-keyword z-operator z-assignment z-makefile">:</span>
<span class="z-meta z-function z-arguments z-makefile"></span><span class="z-meta z-function z-body z-makefile"></span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile"></span><span class="z-meta z-function z-body z-makefile">	<span class="z-source z-shell"><span class="z-meta z-function-call z-shell"><span class="z-support z-function z-printf z-shell">printf</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>%s<span class="z-constant z-character z-escape z-shell">\n</span><span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> <span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>version_fragment<span class="z-keyword z-other z-block z-end z-makefile">)</span></span> <span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> <span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>version_mk<span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span></span>
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile">
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile"></span><span class="z-comment z-line z-number-sign z-makefile"><span class="z-punctuation z-definition z-comment z-makefile">#</span> If past and present version info differ, delete the fragment so it&#39;s recreated.
</span></span><span class="z-source z-makefile"><span class="z-meta z-group z-makefile"><span class="z-keyword z-control z-conditional z-makefile">ifneq</span> <span class="z-punctuation z-section z-group z-begin z-makefile">(</span><span class="z-meta z-function-call z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span><span class="z-support z-function z-builtin z-makefile">file</span> </span><span class="z-meta z-function-call z-arguments z-makefile">&lt;<span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>version_mk<span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span><span class="z-keyword z-other z-block z-end z-makefile">)</span><span class="z-punctuation z-separator z-makefile">,</span><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>version_fragment<span class="z-keyword z-other z-block z-end z-makefile">)</span></span><span class="z-punctuation z-section z-group z-end z-makefile">)</span></span>
</span><span class="z-source z-makefile">  <span class="z-keyword z-other z-block z-begin z-makefile">$(</span><span class="z-support z-function z-builtin z-makefile">shell</span> <span class="z-source z-shell"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>RM<span class="z-keyword z-other z-block z-end z-makefile">)</span></span> <span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>version_mk<span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span><span class="z-keyword z-other z-block z-end z-makefile">)</span>
</span><span class="z-source z-makefile"><span class="z-keyword z-control z-conditional z-makefile">endif</span>
</span><span class="z-source z-makefile">
</span><span class="z-source z-makefile"><span class="z-comment z-line z-number-sign z-makefile"><span class="z-punctuation z-definition z-comment z-makefile">#</span> Include the fragment so we can read the version_str variable.
</span></span><span class="z-source z-makefile"><span class="z-keyword z-control z-import z-makefile">-include</span> <span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>version_mk<span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span></span>
</span><span class="z-source z-makefile">
</span><span class="z-source z-makefile"><span class="z-comment z-line z-number-sign z-makefile"><span class="z-punctuation z-definition z-comment z-makefile">#</span> Rebuild e.g. build/debug/main.o if build/debug/version.mk is recreated.
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-makefile"><span class="z-entity z-name z-function z-makefile"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>main_obj<span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span></span><span class="z-keyword z-operator z-assignment z-makefile">:</span> <span class="z-meta z-function z-arguments z-makefile"><span class="z-string z-unquoted z-makefile"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>version_mk<span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span></span><span class="z-meta z-function z-body z-makefile">
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile"></span>
</span><span class="z-source z-makefile"><span class="z-comment z-line z-number-sign z-makefile"><span class="z-punctuation z-definition z-comment z-makefile">#</span> Add e.g. -DVERSION=&quot;debug-git-dedbeef&quot; to CFLAGS, but only for build/debug/main.o.
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-makefile"><span class="z-entity z-name z-function z-makefile"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>main_obj<span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span></span><span class="z-keyword z-operator z-assignment z-makefile">:</span><span class="z-variable z-other z-makefile"> CFLAGS</span> <span class="z-keyword z-operator z-assignment z-makefile">+=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile">-DVERSION=&quot;<span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>version_str<span class="z-keyword z-other z-block z-end z-makefile">)</span></span>&quot;</span></span>
</span><span class="z-source z-makefile">
</span><span class="z-source z-makefile"><span class="z-comment z-line z-number-sign z-makefile"><span class="z-punctuation z-definition z-comment z-makefile">#</span> Updated static pattern rule to compile *.o files from *.c files.
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-makefile"><span class="z-entity z-name z-function z-makefile"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>c_objs<span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span></span><span class="z-keyword z-operator z-assignment z-makefile">:</span> <span class="z-meta z-function z-arguments z-makefile"><span class="z-string z-unquoted z-makefile"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>objs_dir<span class="z-keyword z-other z-block z-end z-makefile">)</span></span><span class="z-variable z-language z-makefile">%</span>.o: <span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>src_dir<span class="z-keyword z-other z-block z-end z-makefile">)</span></span><span class="z-variable z-language z-makefile">%</span>.c</span></span><span class="z-meta z-function z-body z-makefile">
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile"></span><span class="z-meta z-function z-body z-makefile">	<span class="z-source z-shell"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>CC<span class="z-keyword z-other z-block z-end z-makefile">)</span></span> <span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>CPPFLAGS<span class="z-keyword z-other z-block z-end z-makefile">)</span></span> <span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>CFLAGS<span class="z-keyword z-other z-block z-end z-makefile">)</span></span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-c</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>o</span> <span class="z-variable z-language z-automatic z-makefile">$@</span> <span class="z-meta z-function-call z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span><span class="z-support z-function z-builtin z-makefile">filter-out</span> </span><span class="z-meta z-function-call z-arguments z-makefile"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>version_mk<span class="z-keyword z-other z-block z-end z-makefile">)</span></span><span class="z-punctuation z-separator z-makefile">,</span><span class="z-variable z-language z-automatic z-makefile">$&lt;</span></span><span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span>
</span></span></code></pre>
<p>The line that runs <code>git describe</code> looks funny, but it ensures that the <code>version</code> variable is suffixed by either <code>-git-dedbeef</code> (where <code>dedbeef</code> is the revision hash) or an empty string.</p>
<p>The <code>file</code> function reads in any previous version fragment and compares its contents to that of the current run.
If they differ, the file is deleted;
this needs to be done before the <code>-include</code> line so that GNU Make realizes that the file needs to be recreated.</p>
<p>The rule to compile <code>.o</code> files from <code>.c</code> files is updated to ensure that the Makefile fragment isn't used in the compiler command line.</p>
<p>With all of this in place, <code>src/main.c</code> can print the version info from the <code>VERSION</code> definition given to it like so:</p>
<pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c"><span class="z-meta z-preprocessor z-include z-c"><span class="z-keyword z-control z-import z-include z-c">#include</span> <span class="z-string z-quoted z-other z-lt-gt z-include z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&lt;</span>stdio.h<span class="z-punctuation z-definition z-string z-end z-c">&gt;</span></span>
</span></span><span class="z-source z-c">
</span><span class="z-source z-c"><span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-function z-preprocessor z-c">STRINGIFY2</span></span><span class="z-meta z-preprocessor z-macro z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-variable z-parameter z-c">x</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-preprocessor z-macro z-c"> #x</span>
</span><span class="z-source z-c"><span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-function z-preprocessor z-c">STRINGIFY</span></span><span class="z-meta z-preprocessor z-macro z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-variable z-parameter z-c">x</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">STRINGIFY2</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">x</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span></span>
</span><span class="z-source z-c">
</span><span class="z-source z-c"><span class="z-storage z-modifier z-c">static</span> <span class="z-storage z-type z-c">void</span> <span class="z-meta z-function z-c"><span class="z-entity z-name z-function z-c">printVersion</span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-storage z-type z-c">void</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-function z-c"> </span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span></span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">  <span class="z-meta z-function-call z-c"><span class="z-support z-function z-C99 z-c">puts</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&quot;</span>clox <span class="z-punctuation z-definition z-string z-end z-c">&quot;</span></span> <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">STRINGIFY</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">VERSION</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"></span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span></span>
</span></code></pre>
<p>This <code>printVersion</code> function can then be called from the <code>main</code> function when <code>--version</code> is passed as a command line flag.</p>
<h2 id="automatic-code-formatting"><a class="zola-anchor" href="#automatic-code-formatting" aria-label="Anchor link for: automatic-code-formatting">&num;</a>
Automatic Code Formatting</h2>
<p>I used <a href="https://clang.llvm.org/docs/ClangFormat.html"><strong>clang-format</strong></a> to format code;
even though I worked on this alone, I didn't want to waste time thinking about how to split long lines of code.</p>
<p>The first step to using it is to create a <code>.clang-format</code> file:</p>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> clang-format<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>style</span><span class="z-keyword z-operator z-assignment z-option z-shell">=</span>llvm<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>dump-config</span> <span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> .clang-format</span>
</span></code></pre>
<p>I tweaked this file a bit to set the maximum line length I wanted, and adjust how long lines should be broken across multiple lines.</p>
<p>From here, I created two task targets in my Makefile.
The first reformats source files in-place:</p>
<pre data-lang="make" class="language-make z-code"><code class="language-make" data-lang="make"><span class="z-source z-makefile"><span class="z-comment z-line z-number-sign z-makefile"><span class="z-punctuation z-definition z-comment z-makefile">#</span> From before.
</span></span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">header_dir</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile">...</span></span>
</span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">c_srcs</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile">...</span></span>
</span><span class="z-source z-makefile">
</span><span class="z-source z-makefile"><span class="z-comment z-line z-number-sign z-makefile"><span class="z-punctuation z-definition z-comment z-makefile">#</span> Third-party code that shouldn&#39;t be formatted.
</span></span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">no_format_srcs</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile">...</span></span>
</span><span class="z-source z-makefile">
</span><span class="z-source z-makefile"><span class="z-comment z-line z-number-sign z-makefile"><span class="z-punctuation z-definition z-comment z-makefile">#</span> Source files to format.
</span></span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">format_srcs</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile"><span class="z-meta z-function-call z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span><span class="z-support z-function z-builtin z-makefile">filter-out</span> </span><span class="z-meta z-function-call z-arguments z-makefile"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>no_format_srcs<span class="z-keyword z-other z-block z-end z-makefile">)</span></span><span class="z-punctuation z-separator z-makefile">,</span><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>c_srcs<span class="z-keyword z-other z-block z-end z-makefile">)</span></span> <span class="z-meta z-function-call z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span><span class="z-support z-function z-builtin z-makefile">wildcard</span> </span><span class="z-meta z-function-call z-arguments z-makefile"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>header_dir<span class="z-keyword z-other z-block z-end z-makefile">)</span></span><span class="z-variable z-language z-wildcard z-makefile">*</span>.h</span><span class="z-keyword z-other z-block z-end z-makefile">)</span></span><span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span>
</span><span class="z-source z-makefile">
</span><span class="z-source z-makefile"><span class="z-meta z-function z-makefile"><span class="z-entity z-name z-function z-makefile">.PHONY</span></span><span class="z-keyword z-operator z-assignment z-makefile">:</span> <span class="z-meta z-function z-arguments z-makefile"><span class="z-string z-unquoted z-makefile">format</span></span><span class="z-meta z-function z-body z-makefile">
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile"></span><span class="z-meta z-function z-makefile"><span class="z-entity z-name z-function z-makefile">format</span></span><span class="z-keyword z-operator z-assignment z-makefile">:</span>
<span class="z-meta z-function z-arguments z-makefile"></span><span class="z-meta z-function z-body z-makefile"></span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile"></span><span class="z-meta z-function z-body z-makefile">	<span class="z-source z-shell"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">clang-format</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>i</span> <span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>format_srcs<span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span></span>
</span></span></code></pre>
<p>I'd use this by editing code as usual until I was ready to commit and <code>git add</code> those changes.
I'd then run <code>make format</code> to reformat the code, review the changes using <code>git diff</code>, and tweak things as needed before running <code>git add</code> again and committing the formatted code.</p>
<p>The second task checks if the code formatting is okay and exits with an error if it isn't:</p>
<pre data-lang="make" class="language-make z-code"><code class="language-make" data-lang="make"><span class="z-source z-makefile"><span class="z-comment z-line z-number-sign z-makefile"><span class="z-punctuation z-definition z-comment z-makefile">#</span> From before.
</span></span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">format_srcs</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile">...</span></span>
</span><span class="z-source z-makefile">
</span><span class="z-source z-makefile"><span class="z-meta z-function z-makefile"><span class="z-entity z-name z-function z-makefile">.PHONY</span></span><span class="z-keyword z-operator z-assignment z-makefile">:</span> <span class="z-meta z-function z-arguments z-makefile"><span class="z-string z-unquoted z-makefile">checkformat</span></span><span class="z-meta z-function z-body z-makefile">
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile"></span><span class="z-meta z-function z-makefile"><span class="z-entity z-name z-function z-makefile">checkformat</span></span><span class="z-keyword z-operator z-assignment z-makefile">:</span>
<span class="z-meta z-function z-arguments z-makefile"></span><span class="z-meta z-function z-body z-makefile"></span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile"></span><span class="z-meta z-function z-body z-makefile">	<span class="z-source z-shell"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">clang-format</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>dry-run</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>Werror</span> <span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>format_srcs<span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span></span>
</span></span></code></pre>
<p>I wanted to use this to stop unformatted code from being committed, so I wrote this <code>git-pre-commit.sh</code> script:</p>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell">!/bin/sh</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-support z-function z-set z-shell">set</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">-</span>eu</span></span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash"><span class="z-variable z-other z-readwrite z-assignment z-shell">STASH_NAME</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell"><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>pre-commit-<span class="z-meta z-group z-expansion z-command z-parens z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-punctuation z-section z-parens z-begin z-shell">(</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">date</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>Iseconds</span></span><span class="z-punctuation z-section z-parens z-end z-shell">)</span></span><span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">git</span></span><span class="z-meta z-function-call z-arguments z-shell"> stash push<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>keep-index</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>include-untracked</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-punctuation z-section z-expansion z-parameter z-begin z-shell">{</span></span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-variable z-other z-readwrite z-shell">STASH_NAME</span></span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-section z-expansion z-parameter z-end z-shell">}</span></span><span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">make</span></span><span class="z-meta z-function-call z-arguments z-shell"> checkformat</span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash"><span class="z-keyword z-control z-conditional z-if z-shell">if</span> <span class="z-support z-function z-test z-begin z-shell">[</span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span><span class="z-meta z-group z-expansion z-command z-parens z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-punctuation z-section z-parens z-begin z-shell">(</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">git</span></span><span class="z-meta z-function-call z-arguments z-shell"> stash list</span> <span class="z-keyword z-operator z-logical z-pipe z-shell">|</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">head</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>n</span> 1</span><span class="z-punctuation z-section z-parens z-end z-shell">)</span></span><span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> <span class="z-keyword z-operator z-logical z-shell">=</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>*<span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-punctuation z-section z-expansion z-parameter z-begin z-shell">{</span></span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-variable z-other z-readwrite z-shell">STASH_NAME</span></span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-section z-expansion z-parameter z-end z-shell">}</span></span><span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> <span class="z-support z-function z-test z-end z-shell">]</span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-keyword z-control z-conditional z-then z-shell">then</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">git</span></span><span class="z-meta z-function-call z-arguments z-shell"> stash pop</span>
</span><span class="z-source z-shell z-bash"><span class="z-keyword z-control z-conditional z-end z-shell">fi</span>
</span></code></pre>
<p>The functional part of this script is bracketed with <code>git stash push --keep-index ...</code> and <code>git stash pop</code> to ensure that only the code to be commited is checked by <code>make checkformat</code>.</p>
<p>This script is installed as a pre-commit hook for git like so:</p>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> ln<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>s</span> ../../git-pre-commit.sh .git/hooks/pre-commit</span>
</span></code></pre>
<p>This setup checks that all the code is formatted before allowing it to be committed.</p>
<h2 id="testing"><a class="zola-anchor" href="#testing" aria-label="Anchor link for: testing">&num;</a>
Testing</h2>
<p>As mentioned earlier, I really wanted to write tests for the code I was writing.
I looked at a few C testing frameworks before settling on <a href="https://www.duskborn.com/utest_h/"><strong>utest.h</strong></a>, a single-header testing framework.</p>
<p>If I wanted unit tests for a file named <code>src/foo.c</code>, I'd create a matching <code>src/foo_test.c</code> file, <code>#include "utest.h"</code> at the top and write my test code.
The <code>_test.c</code> suffix would be picked up automatically by the Makefile to produce a test binary at e.g. <code>build/debug/foo_test</code> that could be launched to run its tests.</p>
<p>Aside from these unit tests, I also created <code>src/interpret_test.c</code>, an integration test that sent input strings through the whole clox scanning/parsing/compiling/running machinery and tested for outputs and errors.
This is pretty much the most important test file in the repository, since it tests for desired end-to-end behaviors that the unit tests individually do not.</p>
<p>All of the tests are run via this Makefile task:</p>
<pre data-lang="make" class="language-make z-code"><code class="language-make" data-lang="make"><span class="z-source z-makefile"><span class="z-comment z-line z-number-sign z-makefile"><span class="z-punctuation z-definition z-comment z-makefile">#</span> From before.
</span></span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">tests</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile">...</span></span>
</span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">makefile_prefix</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile">...</span></span>
</span><span class="z-source z-makefile">
</span><span class="z-source z-makefile"><span class="z-meta z-function z-makefile"><span class="z-entity z-name z-function z-makefile">.PHONY</span></span><span class="z-keyword z-operator z-assignment z-makefile">:</span> <span class="z-meta z-function z-arguments z-makefile"><span class="z-string z-unquoted z-makefile">test</span></span><span class="z-meta z-function z-body z-makefile">
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile"></span><span class="z-meta z-function z-makefile"><span class="z-entity z-name z-function z-makefile">test</span></span><span class="z-keyword z-operator z-assignment z-makefile">:</span> <span class="z-meta z-function z-arguments z-makefile"><span class="z-string z-unquoted z-makefile"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>tests<span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span></span><span class="z-meta z-function z-body z-makefile">
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile"></span><span class="z-meta z-function z-body z-makefile">	<span class="z-source z-shell"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>makefile_prefix<span class="z-keyword z-other z-block z-end z-makefile">)</span></span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">runtests.bash</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>tests<span class="z-punctuation z-definition z-substitution z-makefile">:</span><span class="z-variable z-language z-makefile">%</span><span class="z-punctuation z-definition z-assignment z-makefile">=</span>./<span class="z-variable z-language z-makefile">%</span><span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span></span>
</span></span></code></pre>
<p>Running <code>make test</code> would run all the tests through my <code>runtests.bash</code> shell script, which takes the test binaries as arguments, runs them all and prints the names of any tests that fail.</p>
<p>The <code>runtests.bash</code> script: <a href="https://github.com/tung/clox/blob/master/runtests.bash">https://github.com/tung/clox/blob/master/runtests.bash</a></p>
<h2 id="code-coverage"><a class="zola-anchor" href="#code-coverage" aria-label="Anchor link for: code-coverage">&num;</a>
Code Coverage</h2>
<p>Having testing up and running is all fine and well, but how would I know what to test for?
With <em>code coverage</em> instrumentation, I could run the tests in a special "coverage" mode, then process the coverage data into a report to check how much and which parts of the code were actually being tested.</p>
<p>I didn't really want to constantly produce coverage data, so I created a new <code>coverage</code> mode alongside the existing <code>debug</code> and <code>release</code> modes:</p>
<pre data-lang="make" class="language-make z-code"><code class="language-make" data-lang="make"><span class="z-source z-makefile"><span class="z-comment z-line z-number-sign z-makefile"><span class="z-punctuation z-definition z-comment z-makefile">#</span> Updated with &quot;coverage&quot;.
</span></span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">all_modes</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile">debug release coverage</span></span>
</span><span class="z-source z-makefile">
</span><span class="z-source z-makefile"><span class="z-comment z-line z-number-sign z-makefile"><span class="z-punctuation z-definition z-comment z-makefile">#</span> ...
</span></span><span class="z-source z-makefile"><span class="z-keyword z-control z-conditional z-makefile">else</span> <span class="z-meta z-group z-makefile"><span class="z-keyword z-control z-conditional z-makefile">ifeq</span> <span class="z-punctuation z-section z-group z-begin z-makefile">(</span><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>MODE<span class="z-keyword z-other z-block z-end z-makefile">)</span></span><span class="z-punctuation z-separator z-makefile">,</span>coverage<span class="z-punctuation z-section z-group z-end z-makefile">)</span></span>
</span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">  CFLAGS</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile">-Wall -Wextra -Og -g -fsanitize=address -fsanitize=undefined -fno-omit-frame-pointer --coverage</span></span>
</span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">  LDFLAGS</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile">-Og -g -fsanitize=address -fsanitize=undefined --coverage</span></span>
</span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">  LDLIBS</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile">-lm</span></span>
</span></code></pre>
<p>The new flag here is <code>--coverage</code>, which adds coverage instrumentation when added to both <code>CFLAGS</code> and <code>LDFLAGS</code>.
This produces <code>.gcno</code> files in the same directory as the <code>.o</code> files when <code>.c</code> files are compiled.
When the binaries linked with these <code>.o</code> run, coverage data accumulates in <code>.gcda</code> files in that same directory.</p>
<p>The coverage data in the <code>.gcda</code> files can be processed into a multi-file HTML report with the help of <a href="https://gcovr.com"><strong>gcovr</strong></a>.
I worked it into the Makefile like this:</p>
<pre data-lang="make" class="language-make z-code"><code class="language-make" data-lang="make"><span class="z-source z-makefile"><span class="z-comment z-line z-number-sign z-makefile"><span class="z-punctuation z-definition z-comment z-makefile">#</span> BEFORE setting the default mode to &quot;debug&quot;.
</span></span><span class="z-source z-makefile"><span class="z-meta z-group z-makefile"><span class="z-keyword z-control z-conditional z-makefile">ifeq</span> <span class="z-punctuation z-section z-group z-begin z-makefile">(</span><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>MAKECMDGOALS<span class="z-keyword z-other z-block z-end z-makefile">)</span></span><span class="z-punctuation z-separator z-makefile">,</span>gcovr<span class="z-punctuation z-section z-group z-end z-makefile">)</span></span>
</span><span class="z-source z-makefile">  <span class="z-keyword z-control z-makefile">override</span><span class="z-variable z-other z-makefile"> MODE</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile">coverage</span></span>
</span><span class="z-source z-makefile">  <span class="z-meta z-function-call z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span><span class="z-support z-function z-builtin z-makefile">info</span> </span><span class="z-meta z-function-call z-arguments z-makefile">MODE = coverage override for gcovr target.</span><span class="z-keyword z-other z-block z-end z-makefile">)</span>
</span><span class="z-source z-makefile"><span class="z-keyword z-control z-conditional z-makefile">endif</span>
</span><span class="z-source z-makefile">
</span><span class="z-source z-makefile"><span class="z-comment z-line z-number-sign z-makefile"><span class="z-punctuation z-definition z-comment z-makefile">#</span> ...
</span></span><span class="z-source z-makefile">
</span><span class="z-source z-makefile"><span class="z-comment z-line z-number-sign z-makefile"><span class="z-punctuation z-definition z-comment z-makefile">#</span> From before.
</span></span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">mode_dir</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile">...</span></span>
</span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">objs_dir</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile">...</span></span>
</span><span class="z-source z-makefile">
</span><span class="z-source z-makefile"><span class="z-comment z-line z-number-sign z-makefile"><span class="z-punctuation z-definition z-comment z-makefile">#</span> e.g. build/coverage/gcovr/
</span></span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">report_dir</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>mode_dir<span class="z-keyword z-other z-block z-end z-makefile">)</span></span>gcovr/</span></span>
</span><span class="z-source z-makefile">
</span><span class="z-source z-makefile"><span class="z-comment z-line z-number-sign z-makefile"><span class="z-punctuation z-definition z-comment z-makefile">#</span> e.g. build/coverage/gcovr/report.html
</span></span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">report_loc</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>report_dir<span class="z-keyword z-other z-block z-end z-makefile">)</span></span>report.html</span></span>
</span><span class="z-source z-makefile">
</span><span class="z-source z-makefile"><span class="z-comment z-line z-number-sign z-makefile"><span class="z-punctuation z-definition z-comment z-makefile">#</span> Tests, benchmarks and third-party code to exclude from the coverage report.
</span></span><span class="z-source z-makefile"><span class="z-variable z-other z-makefile">report_exclude</span> <span class="z-keyword z-operator z-assignment z-makefile">=</span></span> <span class="z-source z-makefile"><span class="z-meta z-string z-makefile"><span class="z-string z-unquoted z-makefile">...</span></span>
</span><span class="z-source z-makefile">
</span><span class="z-source z-makefile"><span class="z-comment z-line z-number-sign z-makefile"><span class="z-punctuation z-definition z-comment z-makefile">#</span> Create the report directory.
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-makefile"><span class="z-entity z-name z-function z-makefile"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>report_dir<span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span></span><span class="z-keyword z-operator z-assignment z-makefile">:</span> <span class="z-meta z-function z-arguments z-makefile"><span class="z-string z-unquoted z-makefile">| <span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>mode_dir<span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span></span><span class="z-meta z-function z-body z-makefile">
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile"></span><span class="z-meta z-function z-body z-makefile">	<span class="z-source z-shell"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">mkdir</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-variable z-language z-automatic z-makefile">$@</span></span></span>
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile">
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile"></span><span class="z-comment z-line z-number-sign z-makefile"><span class="z-punctuation z-definition z-comment z-makefile">#</span> Generate code coverage report from coverage data.
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-makefile"><span class="z-entity z-name z-function z-makefile"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>report_loc<span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span></span><span class="z-keyword z-operator z-assignment z-makefile">:</span> <span class="z-meta z-function z-arguments z-makefile"><span class="z-string z-unquoted z-makefile"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>objs_dir<span class="z-keyword z-other z-block z-end z-makefile">)</span></span> <span class="z-meta z-function-call z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span><span class="z-support z-function z-builtin z-makefile">wildcard</span> </span><span class="z-meta z-function-call z-arguments z-makefile"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>objs_dir<span class="z-keyword z-other z-block z-end z-makefile">)</span></span><span class="z-variable z-language z-wildcard z-makefile">*</span>.gcda</span><span class="z-keyword z-other z-block z-end z-makefile">)</span> | <span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>report_dir<span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span></span><span class="z-meta z-function z-body z-makefile">
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile"></span><span class="z-meta z-function z-body z-makefile">	<span class="z-source z-shell"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">gcovr</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>report_exclude<span class="z-punctuation z-definition z-substitution z-makefile">:</span><span class="z-variable z-language z-makefile">%</span><span class="z-punctuation z-definition z-assignment z-makefile">=</span>-e <span class="z-variable z-language z-makefile">%</span><span class="z-keyword z-other z-block z-end z-makefile">)</span></span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>html-details</span> <span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>report_loc<span class="z-keyword z-other z-block z-end z-makefile">)</span></span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>r</span> <span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>src_dir<span class="z-keyword z-other z-block z-end z-makefile">)</span></span> <span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>objs_dir<span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span></span>
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile">
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile"></span><span class="z-comment z-line z-number-sign z-makefile"><span class="z-punctuation z-definition z-comment z-makefile">#</span> Print a link to the report once it&#39;s generated.
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-makefile"><span class="z-entity z-name z-function z-makefile">.PHONY</span></span><span class="z-keyword z-operator z-assignment z-makefile">:</span> <span class="z-meta z-function z-arguments z-makefile"><span class="z-string z-unquoted z-makefile">report</span></span><span class="z-meta z-function z-body z-makefile">
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile"></span><span class="z-meta z-function z-makefile"><span class="z-entity z-name z-function z-makefile">report</span></span><span class="z-keyword z-operator z-assignment z-makefile">:</span> <span class="z-meta z-function z-arguments z-makefile"><span class="z-string z-unquoted z-makefile"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>report_loc<span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span></span><span class="z-meta z-function z-body z-makefile">
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile"></span><span class="z-meta z-function z-body z-makefile">	<span class="z-constant z-language z-makefile">@</span><span class="z-source z-shell"><span class="z-meta z-function-call z-shell"><span class="z-support z-function z-printf z-shell">printf</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>Coverage report at: file://%s<span class="z-constant z-character z-escape z-shell">\n</span><span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> <span class="z-meta z-function-call z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span><span class="z-support z-function z-builtin z-makefile">abspath</span> </span><span class="z-meta z-function-call z-arguments z-makefile"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>report_loc<span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span><span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span>
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile">
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile"></span><span class="z-comment z-line z-number-sign z-makefile"><span class="z-punctuation z-definition z-comment z-makefile">#</span> Delete report and reset accumulated .gcda coverage data.
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-makefile"><span class="z-entity z-name z-function z-makefile">.PHONY</span></span><span class="z-keyword z-operator z-assignment z-makefile">:</span> <span class="z-meta z-function z-arguments z-makefile"><span class="z-string z-unquoted z-makefile">cleancoverage</span></span><span class="z-meta z-function z-body z-makefile">
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile"></span><span class="z-meta z-function z-makefile"><span class="z-entity z-name z-function z-makefile">cleancoverage</span></span><span class="z-keyword z-operator z-assignment z-makefile">:</span>
<span class="z-meta z-function z-arguments z-makefile"></span><span class="z-meta z-function z-body z-makefile"></span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile"></span><span class="z-meta z-function z-body z-makefile">	<span class="z-source z-shell"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>RM<span class="z-keyword z-other z-block z-end z-makefile">)</span></span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-r</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>report_dir<span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span></span>
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile">	<span class="z-source z-shell"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>RM<span class="z-keyword z-other z-block z-end z-makefile">)</span></span> <span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>objs_dir<span class="z-keyword z-other z-block z-end z-makefile">)</span></span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">*.gcda</span></span></span>
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile">
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile"></span><span class="z-comment z-line z-number-sign z-makefile"><span class="z-punctuation z-definition z-comment z-makefile">#</span> Run tests with coverage, generate report and show its link.
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-makefile"><span class="z-entity z-name z-function z-makefile">.PHONY</span></span><span class="z-keyword z-operator z-assignment z-makefile">:</span> <span class="z-meta z-function z-arguments z-makefile"><span class="z-string z-unquoted z-makefile">gcovr</span></span><span class="z-meta z-function z-body z-makefile">
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile"></span><span class="z-meta z-function z-makefile"><span class="z-entity z-name z-function z-makefile">gcovr</span></span><span class="z-keyword z-operator z-assignment z-makefile">:</span> <span class="z-meta z-function z-arguments z-makefile"><span class="z-string z-unquoted z-makefile">cleancoverage</span></span><span class="z-meta z-function z-body z-makefile">
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile"></span><span class="z-meta z-function z-body z-makefile">	<span class="z-source z-shell"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>MAKE<span class="z-keyword z-other z-block z-end z-makefile">)</span></span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-f</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-function-call z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span><span class="z-support z-function z-builtin z-makefile">firstword</span> </span><span class="z-meta z-function-call z-arguments z-makefile"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>MAKEFILE_LIST<span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span><span class="z-keyword z-other z-block z-end z-makefile">)</span> MODE=coverage test</span></span>
</span></span><span class="z-source z-makefile"><span class="z-meta z-function z-body z-makefile">	<span class="z-source z-shell"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>MAKE<span class="z-keyword z-other z-block z-end z-makefile">)</span></span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-f</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-function-call z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span><span class="z-support z-function z-builtin z-makefile">firstword</span> </span><span class="z-meta z-function-call z-arguments z-makefile"><span class="z-variable z-parameter z-makefile"><span class="z-keyword z-other z-block z-begin z-makefile">$(</span>MAKEFILE_LIST<span class="z-keyword z-other z-block z-end z-makefile">)</span></span></span><span class="z-keyword z-other z-block z-end z-makefile">)</span> MODE=coverage report</span></span>
</span></span></code></pre>
<p>Running <code>make gcovr</code> with this in place resets everything, builds and runs all of the tests in coverage mode, then produces a multi-file HTML report using gcovr.
Code that is exercised is highlighted in green, while unexercised lines are highlighted red;
I used this as a guide for what to test for.</p>
<p>When running <code>gcovr</code>, using <code>-e foo.c</code> excludes <code>foo.c</code> from the report.
The <code>--html-details</code> option picks the multi-file HTML report format that I want.
The <code>-r</code> option affects the path that source files mentioned in the report are relative to;
I point it right at the source directory for covenience.
The final option is where gcovr should look for the <code>.gcno</code> and <code>.gcda</code> files to produce its report.</p>
<h2 id="benchmarking"><a class="zola-anchor" href="#benchmarking" aria-label="Anchor link for: benchmarking">&num;</a>
Benchmarking</h2>
<p>Benchmarks have a very similar setup to tests in the Makefile, except I write them with the help of <a href="https://github.com/sheredom/ubench.h"><strong>ubench.h</strong></a> instead of utest.h.
Each benchmark is a source file ending with <code>_bench.c</code>, and they're automatically linked by the Makefile, just like the main clox interpreter and the test binaries.</p>
<p>Unlike the tests, each benchmark file contains just one benchmark with some code that takes some time to run;
the ubench.h framework runs the workload multiple times and prints out the statistical mean runtime with outliers removed.</p>
<h2 id="wrapping-up"><a class="zola-anchor" href="#wrapping-up" aria-label="Anchor link for: wrapping-up">&num;</a>
Wrapping Up</h2>
<p>I ended up with a Makefile-centered workflow for following the final part of of <em>Crafting Interpreters</em> that could:</p>
<ul>
<li>Build and link C code with fully automatic dependency resolution.</li>
<li>Format code on demand with <code>make format</code>, and check for unformatted code with a git pre-commit hook.</li>
<li>Build and run all tests by running <code>make test</code>.</li>
<li>Quickly gauge the code coverage of the tests by running <code>make gcovr</code>.</li>
<li>Build all benchmarks by running <code>make buildbenches</code>.</li>
</ul>
<p>The resulting Makefile is pretty complex, but all of the automatic dependency logic meant that if I wanted to add a new file, I could just add <code>foo.c</code>, <code>#include "foo.h"</code> and everything would Just Work.
If I wanted to add a test, I could just write <code>foo_test.c</code> and a test binary would automatically be created, while adding a benchmark was a simple matter doing the same thing with a <code>foo_bench.c</code> file.
I don't know if I'm the first person to work out C link dependencies like this using a Makefile, but if it's been done before, I haven't seen it.</p>
<p>Overall, I'm pretty happy with how this all turned out.</p>

    
  </article>
  <nav class="bottom-nav">
    
    
    
    <p><a href="..">&LeftArrow; More Posts</a></p>
  </nav>

  <footer>
    Made with <a href="https://www.getzola.org">Zola</a>.
  </footer>
</body>

</html>
